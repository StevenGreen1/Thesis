\chapter{Energy Estimators}
\label{chap:energyestimators}

\chapterquote{There, sir! that is the perfection of vessels!}
{Jules Verne, 1828--1905}

%========================================================================================
%========================================================================================

\section{Motivation}
\label{sec:motivation}
% Results use detector model 85 and calibration variant 71
The separation of energy deposits from charged and neutral particles in the calorimeters is crucial for achieving good energy resolutions in the particle flow paradigm.  This is only possible if the energy estimators for those energy deposits are accurate.  The ultimate goal of the calibration procedure outlined in this chapter is to obtain the best energy estimator for particles showering in the calorimeters.  The energy estimator for a cluster of calorimeter hits is:
%
\begin{equation}
E_{Cluster} & = \sum_{ECal \text{ } hits \text{, }i} E^{i}_{ECal} +\sum_{HCal \text{ } hits \text{, }i} E^{i}_{HCal} \text{ ,}
\end{equation}
%
\noindent where $E^{i}_{ECal}$ is the energy of ECal hit $i$, $E^{i}_{HCal}$ is the energy HCal hit $i$ and $\sum$ is the summation over all hits in a given calorimeter.  This is a naive energy estimator that will act as a starting point for the development of more sophisticated procedures aimed at improving detector performance.  However, before going further the calorimeter hit energies must be determined, which for a sampling calorimeter is non-trivial.  Sampling calorimeters, such as those found at the linear collider, are comprised of alternating layers of active and absorber materials \cite{Fabjan:2003aq};  The absorber layers are designed to initiate particle showers and propagate their development, while the active layers are designed to give a response that is proportional to the energy deposited within them.  As the response of a sampling calorimeter gives a measure of the energy deposited in the active layers only, the energy deposited in the absorber medium has to be estimated based on the active layer energies.  This estimation is made by assuming the energy deposited across a calorimeter hit, that is one active and one absorber layer, is uniform.  Working under this assumption, the total calorimeter hit energy is proportional to the active layer hit energy.  This estimation procedure is loosely referred to as digitisation and, in this way, the cluster energy estimator introduced above can be written as:
%
\begin{equation}
E_{Cluster} = \sum_{ECal \text{ } hits \text{, }i} \epsilon^{i}_{ECal} \alpha_{ECal} + \sum_{HCal \text{ } hits \text{, }i} \epsilon^{i}_{HCal} \alpha_{HCal} \text{ ,}
\end{equation}
%
\noindent where $\alpha_{ECal}$ and $\alpha_{HCal}$ are digitisation constants for the ECal and HCal respectively, $\epsilon^{i}_{ECal}$ is the energy response in the active medium for ECal hit $i$, $\epsilon^{i}_{HCal}$ is the energy response in the active medium for a HCal hit $i$ and $\sum$ is the summation over all hits in a given calorimeter.  The first stage of the calibration procedure presented in this chapter covers the determination of these digitisation constants.  

Once the basic energy estimator has been calibrated, it is possible to apply more advanced procedures designed to give a compensating calorimeter response \cite{arXiv:0907.3577}.  A compensating calorimeter produces an identical response to a particle shower irrespective of whether the particle shower is electromagnetic or hadronic in nature.  It is the atomic properties of the materials used in a calorimeter that determine whether a calorimeter is compensating.  The primary cause of a difference in the response of a calorimeter to electromagnetic and hadronic showers is the invisible energy component that is found in hadronic showers.  As this component cannot be measured by the calorimeter, the response is typically lower for hadronically showering particles than for electromagnetically showering particles.  The invisible component exists due to a combination of effects such as neutrons stopping within the calorimeter and nuclear binding energy losses.  If left unchecked, this difference would lead to a systematic loss of energy for hadronic showers that would harm detector performance.  

There are two distinct routes available for negating this unwanted effect and achieving a compensating response from a calorimeter:  The first is hardware compensation \cite{Derrick:1991tq}, whereby calorimeters are constructed using materials that yield extra energy in response to hadronic showers, and the second is software compensation \cite{Tran:2017tgr}, whereby the uncompensated calorimetric energies for hadronic showers are modified at the software level.  The linear collider lends itself to software compensation as the fine segmentation of the calorimeters and precise reconstruction of individual particles makes identification of hadronic showers, and modifying their energies, feasible.  A basic form of software compensation included in the linear collider reconstruction is the modification of the electromagnetic cluster energy estimator to:
%
\begin{equation}
E_{EM \text{ } Cluster} & = \sum_{ECal \text{ } hits \text{, }i} E^{i}_{ECal} \beta^{EM}_{ECal} + \sum_{HCal \text{ } hits \text{, }i} E^{i}_{HCal} \beta^{EM}_{HCal} \text{ ,}
\end{equation}
%
\noindent and the hadronic cluster energy to:
%
\begin{equation}
E_{Had \text{ } Cluster} & = \sum_{ECal \text{ } hits \text{, }i} E^{i}_{ECal} \beta^{Had}_{ECal} + \sum_{HCal \text{ } hits \text{, }i} E^{i}_{HCal} \beta^{Had}_{HCal} \text{ ,}
\end{equation}
%
\noindent where the $\beta$s are scaling factors that are applied to the energy of clusters of calorimeter hits associated with electromagnetic and hadronic clusters in the ECal and HCal.  This simple scaling of energies compensates the response of the calorimeters, which leads to better detector performance.  Determination of these energy scale setting constants is the second stage of the calibration procedure that is presented in this chapter.  

While this scaling of energies improves detector performance, it does not account for any changes to the $\beta$ scaling factors as a function of the total energy deposited.  An energy dependence in the scaling factors is expected as the mechanisms governing the propagation of hadronic showers are sensitive to the shower energy \cite{Wigmans:2000vf}.  To account for this, more sophisticated software techniques have been developed that vary the calorimeter cluster energy estimator as a function of energy to achieve a compensating response across a wider range of energies.  These techniques make use of the fine segmentation of the linear collider calorimeters to identify hadronic showers.  These techniques also address the problem of spuriously high energy calorimeter hits that if left unchecked would damage the reconstruction.  These high energy hits are caused by Landau fluctuations \cite{Landau:1944if}, which originate from high energy knock-on electrons appearing within particle showers \cite{Bichsel:2004ej}.  In this chapter, following a description of the calibration procedure outlined above, is an explanation of these novel energy estimators and the impact they have on detector performance.  

This chapter concludes with a study determining the impact on detector performance of timing cuts that are applied to the calorimeter hits.  These cuts form part of the software trigger that will be used at the linear collider experiment.  Details regarding how all the detector performance metrics used in this chapter are calculated can be found in section \ref{sec:optstudiesmetric}.

%========================================================================================

\subsubsection{Hardware Compensation}
A novel example of hardware compensation is the ZEUS calorimeter \cite{Derrick:1991tq}.  The ZEUS calorimeter was constructed using uranium as the absorber material.  In response to neutral hadrons the uranium undergoes fission producing extra energy that increases the hadronic response of the calorimeter.  The amount of uranium was carefully chosen to achieve a fully compensating calorimeter response i.e. identical calorimeter response to electromagnetic and hadronic showers.  While hardware compensation is possible for the linear collider calorimeters, restrictions on calorimeter construction and the use of a large amount of radioactive material are highly undesirable.  

%========================================================================================

\subsubsection{Calibration and detector optimisation}
Optimising the detector at a future linear collider will be crucial to exploit the full physics potential available to it.  An extensive optimisation of the calorimeters was performed and the results can be found in chapter \ref{sec:optimisationstudies}.  For each detector model considered, the calibration procedure outlined in section \ref{sec:overviewcalibration} was applied to ensure optimal energy estimators were used to quantify the detector performance.  This made it possible to perform unbiased comparisons between detector models, which ensured reliability in the conclusions drawn from those studies.

%========================================================================================

\section{Calibration in the particle flow paradigm}
\label{sec:overviewcalibration}
The calibration procedure described in the following section discusses how the digitisation constants, $\alpha$, and the scaling factors $\beta$ that were introduced in section \ref{sec:motivation} are determined.  In addition to this, minimum ionising particle (MIP) scale setting is included in the calibration procedure to ensure optimal detector performance is achieved.  

The MIP scale is the average energy response, on a per hit level, of a calorimeter when a normally incident MIP passes through it.  This energy scale is used by the digitisation processor and PandoraPFA to apply noise vetoing cuts to the calorimeter hit energies.  The digitisation processor will only create a calorimeter hit if the corresponding active layer energy exceeds a threshold energy, which is defined in units of MIPs.  Similarly, PandoraPFA will only use a calorimeter hit in the reconstruction if the calorimeter hit energy exceeds a threshold energy, which is also defined in units of MIPs.  Both of these cuts are designed to veto noise that would be present in a real detector.  While noise is not explicitly added to the detector simulations, these thresholds are still applied to ensure the simulation better reflects the performance of a real detector.  In addition to this, the MIP scale is used by the digitiser for simulating a number of realistic detector effects.  This includes a truncation of the active layer calorimeter hit energies, which is set in units of MIPs.  This truncation mimics saturation effects in the calorimeter readout technology.  Setting the MIP scale is crucial for ensuring the noise vetoing cuts and realistic effects are correctly applied.
 
The MIP scale in the digitiser and PandoraPFA, while intrinsically linked, have to be calculated separately.  The digitiser requires the MIP scale to be defined using the active layer hit energies while, PandoraPFA requires the definition from the full hit, the active and absorber layer, energies.  It may be expected that the digitisation MIP scale could be related to the PandoraPFA MIP scale by the digitisation constants, however, this is not necessarily the case; additional cuts are applied to the full calorimeter hit energies that are not applied to the active layer hit energies e.g. timing cuts.  Therefore, the conservative approach of independently recalculating the MIP scale for PandoraPFA was taken.   

The $\alpha$ and $\beta$ constants are determined by tuning the mean of reconstructed energy distributions.  A number of cuts are applied when populating these reconstructed energy distributions that ensure the relevant reconstructed energy is being tuned.  The application of these cuts means that linear scaling of the $\alpha$ and $\beta$ constants does not lead to a linear shift in the mean of the reconstructed energy distributions.  Therefore, when calibrating the $\alpha$ and $\beta$ constants an iterative approach is taken; the next iteration of the calibration constant is determined by repeating the reconstruction using the current iteration of the constant and adjusting the constant based on the mean of the reconstructed energy distribution.  

%========================================================================================

\subsubsection{Ordering of Calibration Procedure}
\label{sec:ordercalibration}
The calibration procedure is broadly split into four separate operations: determination of digitisation constants, determination of scaling factor constants and  MIP scale setting in the digitiser and PandoraPFA.  The ordering of each of these calibration steps is crucial as it is possible to get interference between the different stages if applied in an arbitrary order.  With that in mind, the procedure order to minimise interference is as follows:

\begin{enumerate} 
\item Setting the MIP scale setting in the digitiser.  No dependancies on other calibration constants.  
\item Setting the digitisation constants, $\alpha$s.  This relies upon the MIP scale in the digitiser being set.
\item Setting the MIP scale setting in PandoraPFA.  This relies upon correct calibration of calorimeter hit energies, therefore, the $\alpha$s must be calibrated first.
\item Setting the scaling factors, $\beta$s.  This relies upon correct calibration of calorimeter hit energies and correct MIP scale setting in PandoraPFA.
\end{enumerate} 

%========================================================================================

\subsubsection{Photon Likelihood Data}
Some of the algorithms in PandoraPFA make use of likelihood data to identify electromagnetic showers.  This likelihood data consists of a series of probability density functions (PDFs) that describe a number of topological properties of PFOs.  The data contained in these PDFs is related solely to the ECal, which means that every time the ECal is changed from that of the nominal ILD detector this likelihood data must be retrained.  Should retraining be necessary it should be performed after the application of the calibration procedure as described in section \ref{sec:ordercalibration}.  To ensure PandoraPFA gives optimal performance for jet reconstruction, the likelihood data is trained using off-shell mass Z boson events, at 500~GeV, decaying into light quarks (u, d, s).  

%========================================================================================

\subsection{Digitisation Implementation}
\label{sec:digi}
This section discusses how the digitisation constants, $\alpha$, introduced in section \ref{sec:motivation} are determined.  The digitisation constant for a given calorimeter depends upon several factors such as the material properties of the active and absorber layers, the magnetic field strength and energy losses occurring within the gaps in the detector.  Therefore, each calorimeter in the ILD detector model has a distinct constant that must be independently determined. 

%========================================================================================

\subsubsection{ECal Digitisation Implementation}
\label{sec:ecaldigi}
The procedure for determining the digitisation constants in the ECal involves simulation of single $\gamma$ events at energy $E_{MC} = 10$~GeV.  $\gamma$ events are ideal for calibration of the ECal as $\gamma$s are, at this energy, largely contained within the ECal, as shown in figure \ref{fig:ecaldigiphotonsplit}.  This makes them ideal for isolating the ECal digitisation calibration from that of the HCal digitisation calibration.  Events are only used for calibrating the ECal digitisation if they are confined to the ECal.  To that extent, cuts are applied ensuring that the sum of the reconstructed energy found outside the ECal is less than 1\% of $E_{MC}$ and that the $\text{cos}(\theta) < 0.95$, where $\theta$ is the polar angle of the $\gamma$.  The polar angle cut veto events where the $\gamma$ goes down the beam pipe.  $\gamma$ conversions are also vetoed in this event sample at MC level.  The impact of these cuts on the sum of ECal hit energies for the $E_{MC} = 10$~GeV $\gamma$ events is shown in figure \ref{fig:ecaldigiselection}.

\begin{figure}[h!]
\subfloat[]{\label{fig:ecaldigiphotonsplit}\includegraphics[width=0.5\textwidth]{EnergyEstimators/Plots/Calibration/Digitsation/ECal/ECalHCalPhotonSplit.pdf}}
\subfloat[]{\label{fig:ecaldigiselection}\includegraphics[width=0.5\textwidth]{EnergyEstimators/Plots/Calibration/Digitsation/ECal/DigitisationECalSelection.pdf}}
\caption[\protect\subref{fig:ecaldigiphotonsplit} The sum of calorimeter hit energies in ECal and HCal for 10~GeV $\gamma$ events.  \protect\subref{fig:ecaldigiselection} The sum of the ECal calorimeter hit energies for 10~GeV $\gamma$ events with and without the selection cuts.]{\protect\subref{fig:ecaldigiphotonsplit} The sum of calorimeter hit energies in ECal and HCal for 10~GeV $\gamma$ events.  \protect\subref{fig:ecaldigiselection} The sum of the ECal calorimeter hit energies for 10~GeV $\gamma$ events with and without the selection cuts.}
\label{fig:ecaldigi}
\end{figure}

The calibration of the digitisation in the ECal is an iterative procedure, which begins with the simulation of single $\gamma$ events using a trial calibration, with digitisation constant in the ECal $\alpha^{0}_{\text{ECal}}$.  Next the distribution of the sum of calorimeter hit energies within the ECal is produced for events passing the selection cuts, as shown in figure \ref{fig:ecaldigiselection}.  For an ideal calorimeter this distribution should be Gaussian, as described in chapter \ref{chap:detopt}, therefore, a Gaussian fit is applied to this distribution and the mean, $E_{\text{Fit}}$, extracted.  To remove the effect of any outliers in this distribution, the fit is applied to the range of data with the smallest root mean square that contains at least 90 \% of the data.  An example of such a fit is shown in figure \ref{fig:ecaldigifit}.  In the case of ideal calibration, the mean of this fit, $E_{\text{Fit}}$, would be equal $E_{MC}$.  It is assumed that any difference between the two is due to the calibration, therefore, to correct this the digitisation constant from the trial calibration, $\alpha^{0}_{\text{ECal}}$, is rescaled by the ratio of the $E_{MC}$ to $E_{\text{Fit}}$:
%
\begin{equation}
\alpha^{0}_{\text{ECal}} \rightarrow \alpha_{\text{ECal}} = \alpha^{0}_{\text{ECal}} \times \frac{E_{MC}}{E_{Fit}}\text{ ,}
\end{equation}
%
This procedure is then repeated until the $E_{\text{Fit}}$ falls within a specified tolerance.  The tolerance applied here was $|E_{\text{Fit}} - E_{\text{MC}}| < E_{\text{MC}} \times 5 \%$.  The binning used for the fitted histogram is chosen such that the bin width is equal to the desired tolerance on $E_{\text{Fit}}$ e.g. $E_{\text{MC}} \times 5 \% = 0.5$~GeV.  This tolerance is somewhat loose, however, it is tight enough to ensure successful application of PFA.  It should also be emphasised that the PFO energies used for downstream analyses have the electromagnetic and hadronic energy scale corrections applied, which are calibrated to a much tighter accuracy.

\begin{figure}[h!]
\includegraphics[width=0.5\textwidth]{EnergyEstimators/Plots/Calibration/Digitsation/ECal/DigitisationECalFit.pdf}
\caption[Gaussian fit to sum of the ECal calorimeter hit energies for 10~GeV $\gamma$ events with selection cuts.  The coarse binning reflects the tolerance on the digitisation constant calibration.]{Gaussian fit to sum of the ECal calorimeter hit energies for 10~GeV $\gamma$ events with selection cuts.  The coarse binning reflects the tolerance on the digitisation constant calibration.}
\label{fig:ecaldigifit}
\end{figure}

%========================================================================================

\subsubsection{HCal Digitisation Implementation}
\label{sec:hcaldigi}
The calibration for the digitisation in the HCal proceeds in a similar manor to that described for the ECal with a few key differences.  This calibration uses $K^{0}_{L}$ events at $E_{MC} = 20$~GeV as these neutral hadrons will deposit the bulk of their energy in the HCal.  The higher energy, with respect to the ECal digitisation, is used to create larger particle showers that sample deeper into the HCal.  As the $K^{0}_{L}$s must pass through the ECal before arriving at the HCal and, as the ECal contains $\approx 1 \lambda_{I}$, some of the $K^{0}_{L}$s begin showering in the ECal, as shown by figure \ref{fig:hcaldigikaonsplit}.  Such events are unsuitable for calibration of the HCal digitisation constants as rescaling $\alpha^{0}_{\text{HCal}}$ would not lead to a linear change in $E_{\text{Fit}}$.  These events are vetoed in the even selection by requiring events deposit less than less than 5\% of $E_{MC}$ outside of the HCal.  In addition to this, the last layer of the HCal where energy is deposited is required to be in the innermost 90\% of the HCal.  This cut vetoes events that shower late in the HCal and deposit a significant amount of energy in the uninstrumented coil region of the detector.  The impact of these cuts on the sum of HCal calorimeter hit energies for the $E_{MC} = 20$~GeV $K^{0}_{L}$ events is shown in figure \ref{fig:hcaldigiselection}.  There are two HCal digitisation constants used in the detector simulation, one applied for the barrel and another for the endcap.  This is to account for differences in hadronic shower dynamics between the two, such as differing magnetic field configurations in the barrel and endcap.  Both parameters are calibrated in the same manor, but have different cuts on $\theta$, the polar angle of the $K^{0}_{L}$.  For the barrel region of the HCal events are selected if $0.2 < \text{cos}(\theta) < 0.6$, while for the endcap events are selected if $0.8 < \text{cos}(\theta) < 0.9$.  These angular cuts are conservative to account for the transverse profile of the hadronic showers and ensure that they are confined to the relevant sub-detector.  One further difference to the ECal digitisation procedure is that the target reconstructed energy for the $K^{0}_{L}$ samples is the kinetic energy as opposed to the total energy.  As the majority of the neutral hadrons appearing in jets are neutrons and their accessible energy is their kinetic energy, calibrating to the kinetic energy should give the best performance for jet reconstruction.  

\begin{figure}[h!]
\subfloat[]{\label{fig:hcaldigikaonsplit}\includegraphics[width=0.5\textwidth]{EnergyEstimators/Plots/Calibration/Digitsation/HCal/ECalHCalKaon0LSplit.pdf}}
\subfloat[]{\label{fig:hcaldigiselection}\includegraphics[width=0.5\textwidth]{EnergyEstimators/Plots/Calibration/Digitsation/HCal/DigitisationHCalSelection.pdf}}
\caption[\protect\subref{fig:hcaldigikaonsplit} Sum of calorimeter hit energies in ECal and HCal for 20~GeV $K^{0}_{L}$ events.  \protect\subref{fig:hcaldigiselection} Sum of the HCal calorimeter hit energies for a 20~GeV $K^{0}_{L}$ events with and without the selection cuts.]{\protect\subref{fig:hcaldigikaonsplit} Sum of calorimeter hit energies in ECal and HCal for 20~GeV $K^{0}_{L}$ events.  \protect\subref{fig:hcaldigiselection} Sum of the HCal calorimeter hit energies for a 20~GeV $K^{0}_{L}$ events with and without the selection cuts.}
\label{fig:hcaldigi}
\end{figure}

Using these cuts the calibration procedure for the digitisation of the HCal barrel and endcap proceeds in the same manor as was described for the ECal, the details of which can be found in section \ref{sec:ecaldigi}.  Examples of the Gaussian fits applied to the sum of the calorimeter hit energies in the HCal barrel and endcap can be found in figure \ref{fig:hcaldigifit}.  

\begin{figure}[h!]
\subfloat[HCal barrel.]{\label{fig:hcaldigibarrel}\includegraphics[width=0.5\textwidth]{EnergyEstimators/Plots/Calibration/Digitsation/HCal/DigitisationHCalbarrelFit.pdf}}
\subfloat[HCal endcap.]{\label{fig:hcaldigiendcap}\includegraphics[width=0.5\textwidth]{EnergyEstimators/Plots/Calibration/Digitsation/HCal/DigitisationHCalendcapFit.pdf}}
\caption[Gaussian fit to sum of the HCal calorimeter hit energies for 20~GeV $K^{0}_{L}$ events with selection cuts.]{Gaussian fit to sum of the HCal calorimeter hit energies for 20~GeV $K^{0}_{L}$ events with selection cuts.}
\label{fig:hcaldigifit}
\end{figure}

%========================================================================================

\subsubsection{HCal Ring Digitisation Implementation}
\label{sec:hcalringdigi}
The HCal ring, illustrated in figure \ref{fig:calorimeters}, also has an independent digitisation constant to account for any difference in the hadronic shower development between the ring, barrel and endcap.  The procedure used to calibrate this constant has to differs from that presented in section \ref{sec:hcaldigi} as it is unfeasible, due to the depth of the ring, to produce events that are wholly contained within it.  Fortunately, the size of the HCal ring means it plays a minimal role in the reconstruction, so precise calibration is not crucial.  To ensure that the calibration is approximately correct for the HCal ring, $\alpha_{\text{HCal ring}}$ is assumed to equal $\alpha_{\text{HCal endcap}}$ multiplied by several factors designed to accounts for changes in the active layer thickness, absorber layer thickness and the MIP response between the HCal endcap and ring.  In detail:
%
\begin{equation}
\alpha_{\text{HCal ring}} = \alpha_{\text{HCal endcap}} \times \frac{\langle \text{cos}(\theta_\text{endcap}) \rangle}{\langle \text{cos}(\theta_\text{ring}) \rangle} \times \frac{P_\text{endcap} }{P_\text{ring} } \times \frac{L^{Absorber}_\text{endcap}}{L^{Absorber}_\text{ring} } \times \frac{L^{Active}_\text{ring}}{L^{Active}_\text{endcap}} \text{ ,}
\end{equation}
%
\noindent where $\theta$ is the incident angle of the incoming particle to the calorimeter determined using the 20~GeV $K^{0}_{L}$ events, $L^{Active}$ is the active layer thickness and $L^{Absorber}$ is the absorber layer thickness. $P$ is the position of the MIP peak in the distribution of active layer hit energies, which has been corrected so that the MIP appears to enter the calorimeter at normal incidence, and is determined using 10~GeV $\mu^{-}$ events.  Details on how $P$ is determined can be found in section \ref{sec:mipresponse}.

\begin{figure}[h!]
\subfloat[]{\label{fig:ecal}\includegraphics[width=0.33\textwidth]{EnergyEstimators/Plots/Calibration/VisualDisplay/ECalWithScale.pdf}}
\subfloat[]{\label{fig:hcal}\includegraphics[width=0.33\textwidth]{EnergyEstimators/Plots/Calibration/VisualDisplay/HCal.png}}
\subfloat[]{\label{fig:hcalring}\includegraphics[width=0.33\textwidth]{EnergyEstimators/Plots/Calibration/VisualDisplay/HCalring.png}}
\caption[A PandoraPFA event display showing the nominal ILD calorimeters.  \protect\subref{fig:ecal} the ECal, \protect\subref{fig:hcal} the full HCal and \protect\subref{fig:hcalring} the HCal ring.]{A PandoraPFA event display showing the nominal ILD calorimeters.  \protect\subref{fig:ecal} the ECal, \protect\subref{fig:hcal} the full HCal and \protect\subref{fig:hcalring} the HCal ring.}
\label{fig:calorimeters}
\end{figure}

%========================================================================================

\subsection{MIP Scale Determination}
\label{sec:mipresponse}
The digitiser MIP scale was defined as the, non-zero, peak in the distribution of the active layer calorimeter hit energies for normally incident 10~GeV $\mu^{-}$ \cite{Bichsel:2004ej}, as shown in figure \ref{fig:digitisermip}.  This distribution is made for each calorimeter where the MIP scale needs to be determined.  As the average energy deposited per hit in a given sub-detector is relevant for setting the MIP scale, as opposed to the total energy deposited in a sub-detector, no selection cuts are required.  When populating the active layer energy distribution, a direction correction factor of $\text{cos}(\theta)$, where $\theta$ is the incident angle of the $\mu^{-}$ to the calorimeter hit, was applied to the hit energy to generate the effect of having the $\mu^{-}$ enter the calorimeter at normal incidence.  The MIP scale was determined separately for the ECal, HCal barrel, HCal endcap and HCal ring, however, only a single HCal MIP scale, taken as the HCal barrel, was required by the digitisation processor.  The HCal endcap and ring MIP scales were calculated for the purposes of the HCal ring digitisation described in section \ref{sec:hcalringdigi}.  No MIP scale setting was required in the digitisation processor for the muon chamber.  

\begin{figure}[h!]
\subfloat[]{\label{fig:digitisermipecal}\includegraphics[width=0.5\textwidth]{EnergyEstimators/Plots/Calibration/MIPScale/Digitiser/MIPScaleDigitiserECal.pdf}}
\subfloat[]{\label{fig:digitisermiphcalbarrel}\includegraphics[width=0.5\textwidth]{EnergyEstimators/Plots/Calibration/MIPScale/Digitiser/MIPScaleDigitiserHCalbarrel.pdf}} \\
\subfloat[]{\label{fig:digitisermiphcalendcap}\includegraphics[width=0.5\textwidth]{EnergyEstimators/Plots/Calibration/MIPScale/Digitiser/MIPScaleDigitiserHCalendcap.pdf}}
\subfloat[]{\label{fig:digitisermiphcalring}\includegraphics[width=0.5\textwidth]{EnergyEstimators/Plots/Calibration/MIPScale/Digitiser/MIPScaleDigitiserHCalOther.pdf}}
\caption[The active layer calorimeter hit energy distributions for \protect\subref{fig:digitisermipecal} the ECal, \protect\subref{fig:digitisermiphcalbarrel} the HCal barrel, \protect\subref{fig:digitisermiphcalendcap} the HCal endcap and \protect\subref{fig:digitisermiphcalring} the HCal ring for 10~GeV $\mu^{-}$ events.]{The active layer calorimeter hit energy distributions for \protect\subref{fig:digitisermipecal} the ECal, \protect\subref{fig:digitisermiphcalbarrel} the HCal barrel, \protect\subref{fig:digitisermiphcalendcap} the HCal endcap and \protect\subref{fig:digitisermiphcalring} the HCal ring for 10~GeV $\mu^{-}$ events.}
\label{fig:digitisermip}
\end{figure}

A similar procedure was employed for calculation of the MIP peak in PandoraPFA.  The distribution used to set the MIP scale in PandoraPFA is the distribution of the calorimeter hit energies, i.e. the active and absorber layer energies, as opposed to the active layer energies used for setting the MIP scale in the digitisation processor.   Examples of the distributions used to set the MIP scale in PandoraPFA can be found in figure \ref{fig:pandoramip}.  There are few populated low calorimeter hit energy bins in this these distributions as cuts are applied in the digitiser on the active layer energy.  The double peak structure observed in the ECal calorimeter hit energy distribution is expected given the ECal absorber material thickness doubling in the back 10 layers of the ECal.  Further differences between the MIP scale setting in the digitiser and PandoraPFA are as follows: The MIP scale setting in PandoraPFA combines the HCal sub-detectors, the barrel, endcap and ring, together when creating the calorimeter hit energy distributions; PandoraPFA requires the MIP scale to be set in the muon chamber unlike the digitisation processor and, therefore, the muon chamber hit energy distribution must also be created.  

\begin{figure}[h!]
\subfloat[]{\label{fig:pandoramipecal}\includegraphics[width=0.5\textwidth]{EnergyEstimators/Plots/Calibration/MIPScale/PandoraPFA/MIPScalePandoraPFAECal.pdf}}
\subfloat[]{\label{fig:pandoramiphcal}\includegraphics[width=0.5\textwidth]{EnergyEstimators/Plots/Calibration/MIPScale/PandoraPFA/MIPScalePandoraPFAHCal.pdf}} \\
\subfloat[]{\label{fig:pandoramipmuon}\includegraphics[width=0.5\textwidth]{EnergyEstimators/Plots/Calibration/MIPScale/PandoraPFA/MIPScalePandoraPFAMuon.pdf}}
\caption[The calorimeter hit energy distributions for \protect\subref{fig:pandoramipecal} the ECal, \protect\subref{fig:pandoramiphcal} the HCal and \protect\subref{fig:pandoramipmuon} the muon chamber for 10~GeV $\mu^{-}$ events.]{The calorimeter hit energy distributions for \protect\subref{fig:pandoramipecal} the ECal, \protect\subref{fig:pandoramiphcal} the HCal and \protect\subref{fig:pandoramipmuon} the muon chamber for 10~GeV $\mu^{-}$ events.}
\label{fig:pandoramip}
\end{figure}

%========================================================================================

\subsection{Electromagnetic and Hadronic Scale Setting}
\label{sec:scalesetting}

%========================================================================================

\subsubsection{Electromagnetic scale setting}
\label{sec:emscalesetting}
The electromagnetic scale in the ECal, $\beta^{EM}_{ECal}$, is determined using $\gamma$ events at $E_{MC} = 10$~GeV.  $\gamma$ events are ideal for setting the electromagnetic scale as they procedure electromagnetic showers that are primarily confined to the ECal, which is shown by figure \ref{fig:ecaldigiphotonsplit}.  To ensure that the events used for this part of the calibration are largely confined to the ECal, a cut requiring less than 1\% of the reconstructed energy to be found outside the ECal is applied.  Furthermore, a cut requiring a single $\gamma$ be reconstructed are added to veto events with pattern recognition failures.  $\gamma$ conversions are excluded at MC level to ensure energy measurements used in the calibration arise from the calorimeters and not the charged particle tracks.  The impact of these cuts on the electromagnetic energy measured in the ECal for 10~GeV $\gamma$ events is shown in figure \ref{fig:ecalemscaleselection}.  In figure \ref{fig:ecalemscaleselection}, the peak with zero electromagnetic energy in the ECal is due to events traveling down the beam pipe and events with $\gamma$ conversions.  In $\gamma$ conversion events the reconstructed energy is taken from the $\text{e}^{\pm}$ tracks, which means the electromagnetic energy in the ECal will register as zero.  The tail of events with low electromagnetic energy in the ECal occurs primarily due pattern recognition failures in $\gamma$ conversion events.  In such cases, some of the calorimetric energy deposits are not associated to the $\text{e}^{\pm}$ tracks and instead form new $\gamma$s that contain only a small fraction of the true MC energy.  

The fitting procedure follows that used for the ECal digitisation, described in section \ref{sec:ecaldigi}, whereby a trial calibration for the electromagnetic energy scale in the ECal, $\beta^{EM0}_{ECal}$, is assumed and the single $\gamma$ events simulated.  The distribution of the electromagnetic energy in the ECal is created and a Gaussian fit applied to the range of data with the smallest root mean square containing at least 90 \% of the data.  The mean of this fit, $E_{\text{Fit}}$, is then used to scale $\beta^{EM0}_{ECal}$ in the following way:
%
\begin{equation}
\beta^{EM0}_{ECal} \rightarrow \beta^{EM}_{ECal} = \beta^{EM0}_{ECal} \times \frac{E_{MC}}{E_{Fit}}\text{ .}
\end{equation}
%
An example distribution and fit used in the calibration of the nominal ILD detector model can be found in figure \ref{fig:ecalemscalefit}.  This procedure is repeated using the updated $\beta^{EM}_{ECal}$ until $E_{\text{Fit}}$ falls within a specified tolerance.  The tolerance applied here was $|E_{\text{Fit}} - E_{\text{MC}}| < E_{\text{MC}} \times 0.5 \%$.  The binning for the fitted histogram is chosen such that the bin width is equal to the desired target tolerance on $E_{\text{Fit}}$ e.g. $E_{\text{MC}} \times 0.5 \% = 0.05$~GeV.  This tolerance is tighter than was applied for the digitisation as it is these energies that are used in downstream analyses.   
 
\begin{figure}[h!]
\subfloat[]{\label{fig:ecalemscaleselection}\includegraphics[width=0.5\textwidth]{EnergyEstimators/Plots/Calibration/EMScaleSetting/EMScaleECalSelection.pdf}}
\subfloat[]{\label{fig:ecalemscalefit}\includegraphics[width=0.5\textwidth]{EnergyEstimators/Plots/Calibration/EMScaleSetting/EMScaleSettingECalFit.pdf}}
\caption[\protect\subref{fig:ecalemscaleselection} The sum of the electromagnetic energy measured in the ECal for 10~GeV $\gamma$ events with and without the selection cuts.  \protect\subref{fig:ecalemscalefit} Gaussian fit to sum of the electromagnetic energy deposited in the ECal for 10~GeV $\gamma$ events with selection cuts.  The fine binning reflects the tolerance on the electromagnetic scale calibration constant in the ECal.]{\protect\subref{fig:ecalemscaleselection} The sum of the electromagnetic energy measured in the ECal for 10~GeV $\gamma$ events with and without the selection cuts.  \protect\subref{fig:ecalemscalefit} Gaussian fit to sum of the electromagnetic energy deposited in the ECal for 10~GeV $\gamma$ events with selection cuts.  The fine binning reflects the tolerance on the electromagnetic scale calibration constant in the ECal.}
\label{fig:ecalemscale}
\end{figure}
 
The electromagnetic scale in the HCal, $\beta^{EM}_{HCal}$, is chosen to be equal to the hadronic scale in the HCal, $\beta^{Had}_{HCal}$.  The details of the determination of $\beta^{Had}_{HCal}$ can be found in section \ref{sec:hadscalesetting}.  For the ILC and CLIC, $\beta^{EM}_{HCal}$ is not a critical parameter in the reconstruction as $\gamma$s are largely contained within the ECal meaning little to no electromagnetic energy is measured in the HCal.  

%========================================================================================

\subsubsection{Hadronic scale setting}
\label{sec:hadscalesetting}
The hadronic energy scale factors for the ECal and HCal, $\beta^{Had}_{ECal}$ and $\beta^{Had}_{HCal}$, are determined using $K^{0}_{L}$ events at $E_{MC} = 20$~GeV.  The hadronic scale in the ECal, $\beta^{Had}_{ECal}$, is important to detector performance as a non-negligible amount of hadronic energy will be measured in the ECal.  As the ECal contains $\approx 1 \lambda_{I}$, the hadronic scale in the ECal cannot be independently set as it is unfeasible to create a large sample of 20~GeV $K^{0}_{L}$ events that are fully contained within it.  Therefore, the hadronic scale in the ECal and HCal have to be set simultaneously.  

For the reasons outlined in section \ref{sec:hcaldigi}, the target reconstructed energy for this sample is the kinetic energy, $E_{K}$, of the $K^{0}_{L}$ as opposed to the total energy.  To ensure the events used are not affected by leakage of energy out of the back of the HCal, a cut is applied that vetoes events where energy is deposited in the outermost 10\% of the HCal.  In addition to this, a cut requiring a single neutral hadron to be reconstructed is applied to veto events with reconstruction failures.  Finally, it is required that the total hadronic energy measured within the calorimeters fall within three $\sigma$ of the kinetic energy of the $K^{0}_{L}$, where $\sigma$ is defined to be $55\% \times \sqrt{E_{K}}$~GeV.  This definition for $\sigma$ is approximately the energy resolution for neutral hadrons using the nominal ILD HCal \cite{Behnke:2013lya}.  This cut ensures that when fitting the two dimensional distribution of hadronic energy measured in the ECal and HCal outliers do not skew the fit.   The impact of cuts is illustrated in figure \ref{fig:hadscaleselection}.

\begin{figure}[h!]
\subfloat[]{\label{fig:hadscaleselectionnocuts}\includegraphics[width=0.5\textwidth]{EnergyEstimators/Plots/Calibration/HadScaleSetting/HadScaleECalHCalSelectionNoCuts.pdf}}
\subfloat[]{\label{fig:hadscaleselectioncuts}\includegraphics[width=0.5\textwidth]{EnergyEstimators/Plots/Calibration/HadScaleSetting/HadScaleECalHCalSelectionCuts.pdf}}
\caption[The distribution of hadronic energy measured in the ECal and HCal for 20~GeV $K^{0}_{L}$ events with and without selection cuts.]{The distribution of hadronic energy measured in the ECal and HCal for 20~GeV $K^{0}_{L}$ events \protect\subref{fig:hadscaleselectionnocuts} without selection cuts and \protect\subref{fig:hadscaleselectioncuts} with selection cuts.}
\label{fig:hadscaleselection}
\end{figure}

This part of the calibration procedure is again iterative and begins by assuming trial values, $\beta^{Had0}_{ECal}$ and $\beta^{Had0}_{HCal}$, for the hadronic scale calibration factors $\beta^{Had}_{ECal}$ and $\beta^{Had}_{HCal}$.  Following this the 20~GeV $K^{0}_{L}$ events are simulated and reconstructed using these scale factors.  Then a linear fit is applied to the two dimensional distribution of the reconstructed hadronic energies measured in the ECal and HCal for events passing the selection cuts.  The best fit is obtained by minimising $\chi^{2}$ with respect to variables describing a linear fit to the distribution.  In this case, $\chi^{2}$ is defined as:
%
\begin{equation}
\chi^{2}(\delta^{Had}_{ECal}, \delta^{Had}_{HCal}) = \sum_{i} \frac{r_{i}}{\sigma_{r_{i}}}\text{ ,}
\end{equation}
%
\noindent where $r_{i}$ is the perpendicular distance in the two dimensional plane of hadronic energies measured in the ECal and HCal from the point $(x_{i}, y_{i})$ to a straight line passing through the points $(\delta^{Had}_{ECal}, 0)$ and $(0, \delta^{Had}_{HCal})$.  In this definition, $x_{i}$ and $y_{i}$ are the hadronic energies measured in the ECal and HCal respectively for event $i$.  The variables $\delta^{Had}_{ECal}$ and $\delta^{Had}_{HCal}$ describe a linear fit to the hadronic energy distribution, which are to be varied when minimising $\chi^{2}$.  The explicit definition of $r_{i}$ is given in equation \ref{equ:xicalc}, however it is best illustrated by considering figure \ref{fig:hadscalechi2calc}.  The uncertainty on $r_{i}$ is given by $\sigma_{r_{i}}$, which is explicitly defined in equation \ref{equ:sigmaxicalc}.  This uncertainty is calculated by propagating the uncertainties on $x_{i}$ and $y_{i}$, which are assumed to be $\sigma_{x_{i}/y_{i}} = 55\% \times \sqrt{x_{i}/y_{i}}$, into the expression for $r_{i}$.  The sum runs over all events, $i$, passing the selection cuts.  
%
\begin{equation}
r_{i} = \frac{y_{i} \delta^{Had}_{ECal} + x_{i} \delta^{Had}_{HCal} - \delta^{Had}_{ECal} \delta^{Had}_{HCal}}{\sqrt{(\delta^{Had}_{ECal})^{2} + (\delta^{Had}_{HCal})^{2}}}\text{ ,}
\label{equ:xicalc}
\end{equation}
\begin{equation}
\sigma_{i} = \frac{(\sigma_{y_{i}}  \delta^{Had}_{ECal})^{2} + (\sigma_{x_{i}} \delta^{Had}_{HCal})^{2}}{\sqrt{(\delta^{Had}_{ECal})^{2} + (\delta^{Had}_{HCal})^{2}}}\text{ ,}
\label{equ:sigmaxicalc}
\end{equation}
%
\begin{figure}[h!]
\includegraphics[width=0.5\textwidth]{EnergyEstimators/Plots/Calibration/HadScaleSetting/HadScaleECalHCalSelectionExample.pdf}
\caption[An example showing the definition of $r_{i}$, the variable used for the calculation of $\chi^{2}(\delta^{Had}_{ECal}, \delta^{Had}_{HCal})$ in determining the hadronic energy scale factors.]{An example showing the definition of $r_{i}$, the variable used for the calculation of $\chi^{2}(\delta^{Had}_{ECal}, \delta^{Had}_{HCal})$ in determining the hadronic energy scale factors.  For an event that has been measured with hadronic energy $x_{i}$ in the ECal and $y_{i}$ in the HCal, the geometric interpretation of $r_{i}$ is shown.  The blue dotted line is defined as $y_{i} = \delta^{Had}_{HCal} - x_{i} \frac{\delta^{Had}_{HCal}}{\delta^{Had}_{ECal}}$.}
\label{fig:hadscalechi2calc}
\end{figure}
%
\noindent The minimisation of $\chi^{2}$ is done by stepping over a range of $\delta^{Had}_{ECal}$ and $\delta^{Had}_{HCal}$ centred about the ideal value of $E_{K}$ in search for the minimum $\chi^{2}$.  Once the minima in $\chi^{2}$ is found the trial calibration factors $\beta^{Had0}_{ECal}$ and $\beta^{Had0}_{ECal}$ are rescaled to correct for any deviation from the desired fit as follows:
%
\begin{equation}
\beta^{Had0}_{ECal} \rightarrow \beta^{Had}_{ECal} = \beta^{Had0}_{ECal} \times \frac{E_{K}}{\Delta^{Had}_{ECal}} \text{ ,}\\
\beta^{Had0}_{HCal} \rightarrow \beta^{Had}_{HCal} = \beta^{Had0}_{HCal} \times \frac{E_{K}}{\Delta^{Had}_{HCal}}\text{ ,}
\end{equation}
%
\noindent where $\Delta^{Had}_{ECal}$ and $\Delta^{Had}_{ECal}$ are the values of $\delta^{Had}_{ECal}$ and $\delta^{Had}_{ECal}$ giving the minimum $\chi^{2}$.  The step size used for minimising $\chi^{2}$ with respect to $\delta^{Had}_{ECal}$ and $\delta^{Had}_{ECal}$ was chosen such that a single step would correspond to the final tolerance on $\delta^{Had}$, which in this case is $\approx$ 0.1~GeV.  This procedure is then repeated using the updated hadronic scaling factors until $\Delta^{Had}_{ECal}$ and $\Delta^{Had}_{ECal}$ both fall within a specified final tolerance, which in this case it taken to be $|\Delta^{Had}_{E/HCal} - E_{\text{{K}}}| < E_{\text{{K}}} \times 0.5 \% \approx 0.1 \text{GeV}$.

%========================================================================================
%========================================================================================

\section{Novel Energy Estimators}
This section describes the novel energy estimators that were introduced in section \ref{sec:motivation} with a view to improving the energy resolution for hadronic showers.  Two techniques will be discussed; HCal hit energy truncation, which focuses on limiting the impact of Landau fluctuations, and software compensation, which focuses on achieving a compensating response from the calorimeters used in the simulation.  Both of these techniques are implemented by introducing weights, $\omega$, to calorimetric energy deposits found in the HCal:
%
\begin{equation}
E_{Cluster} & = \sum_{ECal \text{ } hits \text{, }i} E^{i}_{ECal} +\sum_{HCal \text{ } hits \text{, }i} E^{i}_{HCal} \omega^{i}(\rho^{i}) \text{ .}
\label{equ:compensation}
\end{equation}
%
\noindent Weights are only applied to calorimeter hits in the HCal as both techniques attempt to modify the energy of hadronic showers, which are primarily contained within the HCal.  The weights, $\omega^{i}$, vary a function of the calorimeter hit energy density, $\rho^{i} = \frac{E^{i}_{HCal}}{V}$, where $V$ is the HCal hit volume.  While the exact weight values depend on the implementation of the technique, a general feature present in both is that at large $E^{i}_{HCal}$ the weight is less than one.  This limits the impact of spuriously high energy hits caused by Landau fluctuations that would otherwise harm detector performance.  The metrics used for quantifying detector performance when using these novel energy estimators are thoroughly defined in chapter \ref{chap:detopt}.

%========================================================================================

\subsection{HCal Hit Energy Truncation}
\label{sec:hcalcelltruncation}
\subsubsection{Application}
The first technique to be examined is a simple truncation of the hadronic energy recorded in any given HCal hit.  This improves the energy estimators for hadronic clusters by limiting the impact of Landau fluctuations.  In terms of $\omega$ introduced in equation \ref{equ:compensation} the truncation corresponds to:
%
\begin{equation}
\omega(\rho) =
\begin{cases}
1 & \text{if } \rho \times V < \kappa \text{ ,} \\
\frac{\kappa}{\rho \times V} & \text{otherwise} \text{ ,}
\end{cases}
\end{equation}
%
\noindent where $\kappa$ is the value of the truncation and $V$ is the volume of a HCal hit.  This weight as a function of hit energy density is shown in figure \ref{fig:hcalcellweight}.  

%========================================================================================

\subsubsection{Results: Energy Resolution}
The application of these weights leads to an improvement in the energy resolution for neutral hadrons, which can be seen in figure \ref{fig:ercelltrunckaons}.  However, a great deal of care has to be given to the truncation energy so that hits from typical hadronic shower development are not truncated, while the spuriously high energy hits are.  Figure \ref{fig:ercelltrunckaons} indicates that a 1~GeV truncation is sufficient for dealing with the Landau fluctuations.  For hit energy truncations greater than this, the energy resolution worsens as the effect Landau fluctuations are not accounted for.  For hit energy truncations below 1~GeV, the truncation is too aggressive and hits from typical hadronic shower development are truncated.  For completion the $\gamma$ energy resolutions as a function of HCal hit energy truncation are shown in figure \ref{fig:ercelltruncphotons}.  As expected the $\gamma$ energy resolution is invariant to the HCal hit energy truncation as the $\gamma$s are largely contained within the ECal.

\begin{figure}[h!]
\includegraphics[width=0.5\textwidth]{EnergyEstimators/Plots/SoftComp/Weights/CellTruncWeights.pdf}
\caption[The weights, $\omega$, used in the HCal hit energy truncation as a function of the energy density of the HCal hit, $\rho$.  The truncation shown here corresponds to a 1~GeV truncation in the nominal ILD HCal.]{The weights, $\omega$, used in the HCal hit energy truncation as a function of the energy density of the HCal hit, $\rho$.  The truncation shown here corresponds to a 1~GeV truncation in the nominal ILD HCal.}
\label{fig:hcalcellweight}
\end{figure}

\begin{figure}[h!]
\subfloat[]{\label{fig:ercelltrunckaons}\includegraphics[width=0.5\textwidth]{EnergyEstimators/Plots/CellTruncation/ER_vs_Kaon0LCellTrunc_50GeVKaon0L.pdf}}
\subfloat[]{\label{fig:ercelltruncphotons}\includegraphics[width=0.5\textwidth]{EnergyEstimators/Plots/CellTruncation/ER_vs_PhotonCellTrunc_100GeVPhoton.pdf}}
\caption[The energy resolution as a function of HCal cell truncation for \protect\subref{fig:ercelltrunckaons} 50~GeV $K^{0}_{L}$ events and \protect\subref{fig:ercelltruncphotons} 100~GeV $\gamma$ events using the nominal ILD detector model.]{The energy resolution as a function of HCal cell truncation for \protect\subref{fig:ercelltrunckaons} 50~GeV $K^{0}_{L}$ events and \protect\subref{fig:ercelltruncphotons} 100~GeV $\gamma$ events using the nominal ILD detector model.}
\label{fig:ercelltrunc}
\end{figure}

%========================================================================================

\subsubsection{Results: Jet Energy Resolution}
There is an improvement in the jet energy resolution when applying a carefully chosen HCal hit energy truncation.  Figure \ref{fig:jercelltrunc} shows the jet energy resolution as a function of jet energy for selected values of the HCal hit energy truncation.  The trends in this plot are complex as the optimal cell truncation varies with the jet energy.  At low energies a 0.5~GeV truncation gives the optimal performance, however, when the jet energies reach $\approx$ 180~GeV a 1~GeV truncation gives the optimal performance.  This is to be expected based on the Landau fluctuations.  The Landau distribution, governing the energy deposition for hadronic showers, is essentially a Gaussian with a high energy tail and as the jet energy increases, the mean of the Gaussian increases and the definition of hit energies falling in the high energy tail changes.  

\begin{figure}[h!]
\includegraphics[width=0.5\textwidth]{EnergyEstimators/Plots/CellTruncation/JER_vs_JetEnergy_HCalCellTruncation.pdf}
\caption[The jet energy resolution as a function of jet energy for various hadronic cell truncations.  The results shown use the nominal ILD detector model.]{The jet energy resolution as a function of jet energy for various hadronic cell truncations.  The results shown use the nominal ILD detector model.}
\label{fig:jercelltrunc}
\end{figure}

While it is challenging to determine the optimal truncation to use for any given detector model, it is clear that applying an appropriate truncation produces significant improvement in detector performance.  Therefore, for the optimisation studies presented in chapter \ref{chap:detopt} this form of novel energy estimator is applied.  The optimal truncation for each detector model considered in that study was determined by performing the reconstruction using range of HCal hit energy truncations and quoting the optimal performance.  The HCal hit energy truncations considered in the optimisation study were 0.5, 0.75, 1, 1.5, 2, 5 and 10~GeV.  For the HCal cell size study the truncation used for the 10, 20, 30, 40, 50 and 100~mm cell size detector was 0.5, 0.75, 1, 1.5, 2 and 5~GeV respectively, for the tungsten HCal options the truncation used was 5~GeV and for all other options the truncation used was 1~GeV.  This optimisation has a significant impact on detector optimisation, which can be seen by comparing the jet energy resolutions obtained when using the optimised cell truncation and a fixed 1~GeV truncation, shown in figure \ref{fig:jerhcalcellopt}.  Without this optimisation of hit energy truncation the significance of the HCal cell size is overinflated and could lead to a misinformed detector design choice.  

\begin{figure}[h!]
\subfloat[]{\label{fig:jerhcalcelloptgoodtrunc}\includegraphics[width=0.5\textwidth]{OptimisationStudies/Plots/JetEnergyResolutions/JER_vs_HCalCellSize.pdf}}
\subfloat[]{\label{fig:jerhcalcelloptbadtrunc}\includegraphics[width=0.5\textwidth]{EnergyEstimators/Plots/CellTruncation/JER_vs_HCalCellSizeBadTruncation.pdf}}
\caption[The jet energy resolution as a function of HCal cell size using a HCal hit energy truncation that is \protect\subref{fig:jerhcalcelloptgoodtrunc} optimised and \protect\subref{fig:jerhcalcelloptbadtrunc} fixed at 1~GeV.]{The jet energy resolution as a function of HCal cell size using a HCal hit energy truncation that is \protect\subref{fig:jerhcalcelloptgoodtrunc} optimised and \protect\subref{fig:jerhcalcelloptbadtrunc} fixed at 1~GeV.}
\label{fig:jerhcalcellopt}
\end{figure}

%========================================================================================

\subsection{Software Compensation}
\label{sec:softcomp}
\subsubsection{Application}
A particle shower produced when a hadron passing through a calorimeter has two components \cite{Wigmans:2000vf}; an electromagnetic shower core, which originates from the production and decay of $\pi^{0}$s and $\eta$s, and a hadronic shower component originating from all other interacting and decaying particles in the shower.  By identifying each of these components in the reconstruction, it is possible to increase the energy of the hadronic hits to give a compensating response and decrease the energy of spuriously high energy hits that come from Landau fluctuations.  The challenge of applying this approach is to identify whether a hit is likely to be hadronic or electromagnetic in nature.  This is done based on the energy density of a hit, with high energy densities likely to be part of the electromagnetic core and low energy densities likely to be part of satellite hadronic hits around the shower core.  An event display showing the energy density of a hadronic shower, where the electromagnetic core can be clearly seen, in a 500~GeV Z$\rightarrow$uds di-jet event can be found in figure \ref{fig:softcompeventdisplay}.  

\begin{figure}[h!]
\subfloat[]{\label{fig:softcompfulleventdisplay}\includegraphics[width=0.5\textwidth]{EnergyEstimators/Plots/SoftComp/VisualDisplay/SoftComp1.png}}
\subfloat[]{\label{fig:softcompclustereventdisplay}\includegraphics[width=0.3\textwidth]{EnergyEstimators/Plots/SoftComp/VisualDisplay/SoftComp3.png}}
\caption[An event display for a 500~GeV Z$\rightarrow$uds di-jet event reconstructed using the nominal ILD detector.  \protect\subref{fig:softcompfulleventdisplay} The full event environment.  \protect\subref{fig:softcompclustereventdisplay} A single hadronic cluster from the same event where shading indicates the energy density in the HCal.  High energy density cells are coloured red, while lower energy density cells are coloured blue.  All ECal hits are shaded black.  The high energy density electromagnetic core of the selected hadronic cluster is clearly visible.]{An event display for a 500~GeV Z$\rightarrow$uds di-jet event reconstructed using the nominal ILD detector.  \protect\subref{fig:softcompfulleventdisplay} The full event environment.  \protect\subref{fig:softcompclustereventdisplay} A single hadronic cluster from the same event where shading indicates the energy density in the HCal.  High energy density cells are coloured red, while lower energy density cells are coloured blue.  All ECal hits are shaded black.  The high energy density electromagnetic core of the selected hadronic cluster is clearly visible.}
\label{fig:softcompeventdisplay}
\end{figure}

An additional layer of sophistication in this approach is the weights that are applied vary as a function of the uncompensated cluster energy, $E_{\text{Raw}}$, as well as the hit energy density, $\rho^{i}$.  This is to account for any changes to the distribution of calorimeter hit energy densities as the total shower energy is varied.  For example, the fraction of hits in a hadronic shower that are electromagnetic in nature increases as the total energy of the hadronic shower increases \cite{Wigmans:2000vf}.  Therefore, as the total shower energy increases a smaller fraction of hits will require weights greater than one as there are less fully hadronic hits in the shower than at low energies.  The highly segmented calorimeters used at the linear collider experiment will give excellent spatial resolution for individual particle showers, which enables precise mapping of the calorimeter hits to different shower components.  This allows the linear collider to employ this software compensation technique with greater effectiveness than was possible for previous collider experiments.  

In terms of the parameterisation introduced in equation \ref{equ:compensation}, the weights used for this technique are \cite{Adloff:2012gv}:
%
\begin{equation}
\omega(E_{\text{Raw}}, \rho) = p_{1}(E_{\text{Raw}}) \times exp(p_{2}(E_{\text{Raw}}) \times \rho) + p_{3}(E_{\text{Raw}}) \\
p_{1} = p_{11} + p_{12} \times E_{\text{Raw}} + p_{13} \times E_{\text{Raw}}^{2} \\
p_{2} = p_{21} + p_{22} \times E_{\text{Raw}} + p_{23} \times E_{\text{Raw}}^{2} \\
p_{3} = \frac{p_{31}}{p_{32} + exp(p_{33} \times E_{\text{Raw}})}\text{ ,}
\label{equ:softcompweight}
\end{equation}
\noindent where $p_{ij}$ are trained parameters and:
\begin{equation}
E_{Raw} & = \sum_{ECal \text{ } hits \text{, }i} E^{i}_{ECal} +\sum_{HCal \text{ } hits \text{, }i} E^{i}_{HCal} \text{ .}
\end{equation}
%
\noindent The parameters $p_{ij}$ are determined by performing a $\chi^{2}$ fit of the software compensated cluster energy to the MC energy for samples of $K^{0}_{L}$ ranging from 10 to 100~GeV in steps of 10~GeV.  Using the fitted parameters obtained for the nominal ILD detector, $p_{1}$, $p_{2}$ and $p_{3}$ as a function of $E_{\text{Raw}}$ is shown in figure \ref{fig:softcompparams} and $\omega(E_{\text{Raw}}, \rho)$ as a function of $\rho$ for selected values of $E_{\text{Raw}}$ is shown in figure \ref{fig:softcompweights}.  Figure \ref{fig:softcompweights} shows that the high energy density hits are being reduced in energy to compensate for the effects of Landau fluctuations, while the low energy density hits are being increased in weight to compensate for the invisible energy component found in hadronic showers.  Furthermore, the weights vary as a function of the raw hadronic shower energy to account for the changing energy density topology of hadronic showers with increasing shower energy.

\begin{figure}[h!]
\subfloat[]{\label{fig:softcompparam1}\includegraphics[width=0.33\textwidth]{EnergyEstimators/Plots/SoftComp/Weights/SoftwareCompensationParam1.pdf}}
\subfloat[]{\label{fig:softcompparam2}\includegraphics[width=0.33\textwidth]{EnergyEstimators/Plots/SoftComp/Weights/SoftwareCompensationParam2.pdf}}
\subfloat[]{\label{fig:softcompparam3}\includegraphics[width=0.33\textwidth]{EnergyEstimators/Plots/SoftComp/Weights/SoftwareCompensationParam3.pdf}}
\caption[Parameters used in software compensation weight determination as a function of $E_{\text{Raw}}$.]{Parameters used in software compensation weight determination as a function of $E_{\text{Raw}}$.}
\label{fig:softcompparams}
\end{figure}

\begin{figure}[h!]
\includegraphics[width=0.5\textwidth]{EnergyEstimators/Plots/SoftComp/Weights/SoftwareCompensationWeights.pdf}
\caption[The software compensation weight applied to a calorimeter hit as a function of calorimeter hit energy density for various cluster energies.]{The software compensation weight applied to a calorimeter hit as a function of calorimeter hit energy density for various cluster energies.}
\label{fig:softcompweights}
\end{figure}

This technique is applied in the PandoraPFA framework in the form of an energy correction function, which means whenever the energy of a cluster of hits is considered by PandoraPFA the software compensated energy is used.  Applying software compensation in this way benefits the detector energy resolution in two ways; firstly, the intrinsic energy resolution of the detector improves and secondly, the confusion contribution to the energy resolution is reduced.

As software compensation only modifies the energy of HCal hits there is freedom to apply further energy corrections to the ECal hits.  Applying the Clean Clusters logic, described in section \ref{sec:legacycorrections}, to the ECal hits alongside software compensation was found to be beneficial to the jet energy resolution.  Therefore, the application of software compensation within PandoraPFA implicitly involves the application of the Clean Clusters logic to the ECal hits.  

Software compensation was trained using a maximum $K^{0}_{L}$ energy of 100~GeV, therefore, it is only applied to clusters where $E_{\text{Raw}} < 100$~GeV as sensible behaviour outside this range cannot be ensured.  While it would be possible to modify the energy range of the training sample to go to higher energies, hadronic clusters with energy greater than 100~GeV will be rare at the ILC like energies considered here.

%========================================================================================

\subsubsection{Context: Legacy Energy Corrections}
\label{sec:legacycorrections}
Before examining the impact of software compensation on detector performance is it necessary to address the 'legacy' energy corrections that are used by default in PandoraPFA.  The three energy correction that were in use prior to the development of software compensation are:

\begin{itemize}
\item \textbf{HCal hit energy truncation}, the details of which can be found in section \ref{sec:hcalcelltruncation}.
\item \textbf{Clean Clusters}.  This algorithm checks to see whether the energy measured within a calorimeter hit is anomalously high.  Anomalously high energy hits are defined as hits where the energy contained within the hit is greater than 10\% of the energy of the cluster that the hit has been associated to.  If a hit is deemed to have an anomalously high energy and if this energy is above a threshold (0.5~GeV) the hit energy used by PandoraPFA is modified.  The updated hit energy is taken as the average hit energy in the calorimeter layers immediately before and after the layer containing the high energy hit.    
\item \textbf{Scale Hot Hadrons}.  This algorithm calculates the average number of MIP equivalent particles passing through each calorimeter hit in a cluster.  If this number is larger than a given value, default 15 MIPs per hit, the cluster energy is rescaled to give a lower average number of MIPs per hit, default is 5 MIPs per hit.  
\end{itemize}

Each of these energy corrections help to deal with the effects of spuriously high energy hits the origin of which is described in section \ref{sec:hcalcelltruncation}.  However, the algorithms are simplistic and software compensation is expected to give far better results than these 'legacy' options.  The optimisation studies presented in section \ref{chap:detopt} use all three of these legacy options simultaneously, which was the default behaviour for PandoraPFA when the studies were undertaken.  The new default behaviour in PandoraPFA is to use software compensation.

%========================================================================================

\subsubsection{Results: Energy Resolution}
\label{sec:softcomper}
The energy resolution as a function of the MC energy for single $K^{0}_{L}$ events is shown in figure \ref{fig:ersoftcomp} using various energy correction settings.  When comparing the energy resolution given by software compensation to that obtained using no energy corrections, it can be seen that software compensation offers a gain of $\approx 2 \%$ in energy resolution across the energy range considered.  The uniformity of this improvement is encouraging, indicating software compensation is achieving a compensating calorimeter response across this wide range of energies.  

Comparing the performance of software compensation to the legacy corrections it can be seen that software compensation gives a better energy resolution across almost the entire range of energies considered.  The only exception to this is around $E_{K^{0}_{L}} \approx 50$~GeV where the performance of software compensation and the legacy corrections are comparable.  By removing the hit truncation from the legacy options it is clear that the changes in energy resolution when using the legacy options are being driven by the hit truncation.  This makes the trend in energy resolution observed using the legacy corrections clear as, at low $K^{0}_{L}$ energies, very few hits are affected by the truncation so the performance is comparable to not using any energy corrections.  At high $K^{0}_{L}$ energies, the truncation is too aggressive and removes energy from hits that are not spuriously high leading to a worsening energy resolution.  Between these two extremes, $E_{K^{0}_{L}} \approx 50$~GeV, the truncation works ideally and the improvement in energy resolution when using the legacy corrections is the largest.  

\begin{figure}[h!]
\includegraphics[width=0.5\textwidth]{EnergyEstimators/Plots/SoftComp/EnergyResolution/ER_vs_Kaon0LSoftComp_Kaon0L.pdf}
\caption[The energy resolution as a function of the MC energy for single $K^{0}_{L}$ events using various energy correction settings.  The detector model used was the nominal ILD detector model.]{The energy resolution as a function of the MC energy for single $K^{0}_{L}$ events using various energy correction settings.  The detector model used was the nominal ILD detector model.}
\label{fig:ersoftcomp}
\end{figure}

%========================================================================================

\subsubsection{Results: Jet Energy Resolution}
The improvements in the intrinsic energy resolution of the detector observed when using software compensation will propagate into the reconstruction of jets.  These effects are illustrated by examining the jet energy resolution as a function of jet energy, which is shown in figure \ref{fig:jersoftcomp}.  Again it is clear that software compensation is extremely beneficial to the detector performance as it gives a significant reduction in the jet energy resolution in comparison to using the legacy energy corrections.  

\begin{figure}[h!]
\includegraphics[width=0.5\textwidth]{EnergyEstimators/Plots/SoftComp/JetEnergyResolution/JER_vs_JetEnergy_Default.pdf}
\caption[The jet energy resolution as a function of the jet energy for a variety of different energy correction options.  These results were produced for the nominal ILD detector model.]{The jet energy resolution as a function of the jet energy for a variety of different energy correction options.  These results were produced for the nominal ILD detector model.}
\label{fig:jersoftcomp}
\end{figure}

Further light can be shed on these trends by examining the contributions to the jet energy resolutions from the intrinsic energy resolution and the pattern recognition confusion, which are shown in figure \ref{fig:jerbreakdownsoftcomp}.  The intrinsic energy resolution contribution shows that software compensation is significantly better than all other energy corrections options, which is to be expected from the energy resolution studies presented in section \ref{sec:softcomper}.  Unlike the single particle study there is no jet energy for which the hit truncation matches the performance obtained using software compensation.  This is due to the fact that the energy resolution when using the hit truncation is only comparable to the energy resolution using software compensation for a narrow range of hadronic cluster energies.  As the jet contains a broad spectrum of hadronic cluster energies the performance obtained when using the hit truncation will always be worse than when using software compensation.  When comparing the jet energy resolution for the legacy corrections is again apparent that the term driving the jet energy resolution is the hit truncation.

\begin{figure}[h!]
\subfloat[]{\label{fig:jerbreakdownsoftcomp1}\includegraphics[width=0.5\textwidth]{EnergyEstimators/Plots/SoftComp/JetEnergyResolution/JER_vs_JetEnergy_PerfectPFA.pdf}}
\subfloat[]{\label{fig:jerbreakdownsoftcomp2}\includegraphics[width=0.5\textwidth]{EnergyEstimators/Plots/SoftComp/JetEnergyResolution/JER_vs_JetEnergy_TotalConfusion.pdf}}
\caption[The contributions to the jet energy resolution as a function of the jet energy for a variety of different energy correction options.  \protect\subref{fig:jerbreakdownsoftcomp1} is the intrinsic energy resolution of the detector and \protect\subref{fig:jerbreakdownsoftcomp2} is the total confusion term.  The quadrature sum of both yields the standard reconstruction performance.  These results were produced for the nominal ILD detector model.]{The contributions to the jet energy resolution as a function of the jet energy for a variety of different energy correction options.  \protect\subref{fig:jerbreakdownsoftcomp1} is the intrinsic energy resolution of the detector and \protect\subref{fig:jerbreakdownsoftcomp2} is the total confusion term.  The quadrature sum of both yields the standard reconstruction performance.  These results were produced for the nominal ILD detector model.}
\label{fig:jerbreakdownsoftcomp}
\end{figure}

The confusion contributions to the jet energy resolution when using software compensation and the legacy corrections are almost identical.  This indicates that the improvement seen in the jet energy resolution when comparing software compensation and the legacy corrections, shown in figure \ref{fig:jersoftcomp}, is being driven by the intrinsic energy resolution.  The hit truncation and software compensation techniques both improve the energy resolution of the hadronic clusters, however, software compensation is far more effective.  

At low jet energies the Clean Clusters and Scale Hot Hadrons energy corrections are beneficial for reducing the confusion contribution, while the hit truncation is largely redundant.  For high jet energies jets this trend is reversed.  As the Clean Clusters and Scale Hot Hadrons energy corrections do not alter the intrinsic energy resolution of the detector, it is clear that they are compensating for failures in the pattern recognition, which occur primarily at low jet energies.  By extracting the Clean Clusters logic, which is the driving term reducing the confusion contribution to the jet energy resolution at low jet energies, and embedding it within the software compensation energy correction, it is possible to obtain exceptional jet energy resolutions that will extend the physics reach of the linear collider detector.  

%========================================================================================
%========================================================================================

%HERE

\section{Timing Cuts}
The linear collider will operate using a trigger-less readout approach whereby the recorded data for each sub-detector is readout between collisions of $\text{e}^{+}$ and $\text{e}^{-}$ bunches.  The train structure for ILC and CLIC, at their maximum operating energy, is shown in table \ref{table:trainstructure}.  Event selection will proceed through the application of a software trigger.  This involves the identification of any hard interactions, prior to full event reconstruction, and only putting data into the event reconstruction if it is measured within a chosen time window about these interactions.  The recorded time of a calorimeter hit, which is cut on to make the time window for the software trigger, is corrected for straight time-of-flight to the IP.  This ensures that the amount of time particle showers have to develop in the calorimeters is independent of their position in the detector.  As the width of this time window changes, the amount of time particle showers have to develop changes, which will affect the performance of the detector.  

\begin{table}[h!]
\centering
\begin{tabular}{l r r}
\hline
& ILC 500~GeV & CLIC 3 TeV \\
\hline
Electrons per bunch [$10^{10}$] & 2.0 & 0.37 \\
Bunches per train & 2820 & 312 \\
Train repetition rate [Hz] & 5 & 50 \\
Bunch separation [ns] & 308 & 0.5 \\
\end{tabular}
\caption[The train structure for 500~GeV ILC and 3 TeV CLIC \cite{Behnke:2013lya,Linssen:2012hp}.]{The train structure for 500~GeV ILC and 3 TeV CLIC \cite{Behnke:2013lya,Linssen:2012hp}.}
\label{table:trainstructure}
\end{table}

For all choices of time window considered in this study the calibration procedure described in section \ref{sec:overviewcalibration} was applied.  This ensure that the mean of the reconstructed energy distributions will be invariant to changes in the calorimeter timing window as the calibration procedure compensates for any energy losses incurred by truncating the particle shower development time.  

%========================================================================================

\subsubsection{Results: Energy Resolution}
The energy resolution for100~GeV $\gamma$ and 50~GeV $K^{0}_{L}$ events as a function of the timing window applied to the calorimeter hits is shown, for the nominal ILD detector, in figure \ref{fig:ertimingcuts}.  The timing cut makes little difference to the energy resolution of the $\gamma$ events, however, there is a significant decrease in the energy resolution for the neutral hadrons.  This is to be expected as electromagnetic showers develop far more rapidly than their hadronic counterparts \cite{Wigmans:2000vf}, which is shown in figure \ref{fig:calohittiming}.  Hadronic showers develop slowly as they often involve intermediate states that must decay to continue the propagation of the shower and as these states have non-zero lifetimes they slow the propagation of the shower.  If a narrow calorimeter timing window is used, energy measurements from the hadronic shower will be lost and the energy resolution will degrade, which is what is observed.  

\begin{figure}[h!]
\subfloat[]{\label{fig:ertimingcutsphotons}\includegraphics[width=0.5\textwidth]{EnergyEstimators/Plots/TimingCuts/ER_vs_PhotonTiming_100GeVPhoton.pdf}}
\subfloat[]{\label{fig:ertimingcutskaons}\includegraphics[width=0.5\textwidth]{EnergyEstimators/Plots/TimingCuts/ER_vs_Kaon0LTiming_50GeVKaon0L.pdf}}
\caption[The energy resolution as a function of calorimeter timing window for \protect\subref{fig:ertimingcutsphotons} 100~GeV $\gamma$ events and \protect\subref{fig:ertimingcutskaons} 50~GeV $K^{0}_{L}$ events using the nominal ILD detector model.]{The energy resolution as a function of calorimeter timing window for \protect\subref{fig:ertimingcutsphotons} 100~GeV $\gamma$ events and \protect\subref{fig:ertimingcutskaons} 50~GeV $K^{0}_{L}$ events using the nominal ILD detector model.}
\label{fig:ertimingcuts}
\end{figure}

\begin{figure}[h!]
\centering
\includegraphics[width=0.5\textwidth]{OptimisationStudies/Plots/Description/CalorimeterHitTimes_91GeV_Z_uds_Steel.pdf}
\caption[The distribution of the time of the calorimeter hits, corrected for time of flight to the impact point, for 91~GeV Z$\rightarrow$uds di-jet events.]{The distribution of the time of the calorimeter hits, corrected for time of flight to the impact point, for 91~GeV Z$\rightarrow$uds di-jet events.}
\label{fig:calohittiming}
\end{figure} 

%========================================================================================

\subsubsection{Results: Jet Energy Resolution}
The jet energy resolution as a function of the jet energy for selected calorimeter time windows is shown in figure \ref{fig:jertimingcuts}.  As expected, the jet energy resolution will also be affected by the reduced neutral hadron energy resolution when the calorimeter timing window is reduced.  The sole exception to this is the 250~GeV jets for the 100~ns time window whereby the jet energy resolution is slightly better than when using the 300~ns and semi-infinite time windows.  As the magnitude of the changes to the jet energy resolution when varying the time window size are small in comparison to the absolute resolutions, this exception will most likely be due to a fluctuation in either the event sample used or in the application of the calibration procedure.  

\begin{figure}[h!]
\includegraphics[width=0.5\textwidth]{EnergyEstimators/Plots/TimingCuts/JER_vs_JetEnergy_TimingCutStudies.pdf}
\caption[The jet energy resolution as a function of jet energy for various calorimeter timing cuts.  The results shown use the nominal ILD detector model.]{The jet energy resolution as a function of jet energy for various calorimeter timing cuts.  The nominal ILD detector model was used for this study.}
\label{fig:jertimingcuts}
\end{figure}

The time window applied to the calorimeter hits affects both the neutral hadron and jet energy resolutions with a larger timing window leading to better resolutions.  It can be seen that applying an aggressive choice of time window, such as 10~ns, the jet energy resolution is degraded as many of the hadronic showers being sampled do not have time to fully develop.  However, even using a 10~ns timing cut the jet energy resolutions are still sufficiently low to give excellent detector performance.  Both the single particle and jet energy resolutions indicate that the majority of hadronic showers will have fully developed within 100~ns and that there are little gains to be made by extending the size of this window.  

For results presented in this chapter and the optimisation studies found in chapter \ref{chap:detopt} a 100~ns timing window was applied across all models considered.  As the choice of timing window has yet to be finalised for the linear collider this value was chosen as it represents something that could be achieved using the readout technology options presently available \cite{Adloff:2014rya}.  Furthermore, it adds additional realism to the detector simulation in comparison to omitting the effect of the calorimeter time window.  The categorisation of changes to the detector performance when varying the calorimeter timing window presented here can be used to discern the impact of changing the timing window used for the optimisation studies at a later date if so desired.  

%========================================================================================
%========================================================================================
