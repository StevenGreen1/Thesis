\chapter{Energy Estimators}
\label{chap:energyestimators}

\chapterquote{There, sir! that is the perfection of vessels!}
{Jules Verne, 1828--1905}

%========================================================================================
%========================================================================================

% Think about splitting this as possible need to redefine these variables....

\section{Novel Energy Estimators}
This section describes two novel energy estimators that are introduced with a view to improving the energy resolution for hadronic showers.  Two techniques will be discussed: HCal hit energy truncation, which focuses on limiting the impact of Landau fluctuations; and software compensation, which focuses on obtaining a compensating calorimeter response.  Both of these techniques are implemented by introducing weights, $\omega^{i}$, to calorimetric energy deposits made by showering particles in the HCal.  The energy of a showering particle, $E_{Cluster}$, is determined by grouping together a clusters of calorimeter hits and summing their energies.  When weights are applied to HCal hits this energy estimator becomes 
%
\begin{equation}
E_{Cluster} & = \sum_{ECal \text{ } hits \text{, }i} E^{i}_{ECal} +\sum_{HCal \text{ } hits \text{, }i} E^{i}_{HCal} \omega^{i}(\rho^{i}) \text{ .}
\label{equ:compensation}
\end{equation}
%
\noindent Weights are only applied to calorimeter hits in the HCal as these techniques modify the energy of hadronic showers, which are primarily contained within the HCal.  The weights, $\omega^{i}$, vary a function of the energy density of the calorimeter hit, $\rho^{i} = E^{i}_{HCal}/V$ where $V$ is the physical volume of a calorimeter hit in the HCal, which includes the both the active and absorber layer thicknesses.  

Although the exact weights depend on the implementation of the technique, a general feature is that at large $E^{i}_{HCal}$ the weight is less than one.  This limits the impact of spuriously high energy hits caused by Landau fluctuations.  The energy loss probability distribution function for scintillator detectors, such as the ILD HCal, is given by a Landau function, which is essentially a Gaussian function with a high energy tail \cite{Landau:1944if}.  Energy deposits from the high energy tail of this distribution, which are known as Landau fluctuations, account for high energy knock-on electrons that appear within particle showers \cite{Bichsel:2004ej}.  As Landau fluctuations deposit a disproportionately large amount of energy with respect to the bulk of the particle shower, they can lead to overestimates of the particle shower energy.  

The energy loss probability distribution function for $n$ particles passing through a calorimeter hit is given by the convolution of $n$ Landau functions, which by the central limits theorem will tend to a Gaussian as $n$ becomes large.  Consequently, as the average number of particles passing through a calorimeter hit increases, the high energy tail in the energy loss probability distribution function for the hit becomes less pronounced and the impact of Landau fluctuations decreases.  This means that the impact of Landau fluctuations on energy measurements is dictated by the density of a particles within a particle shower and the transverse segmentation, or cell size, of the calorimeter in use.  If the transverse segmentation, or cell size, of a calorimeter decreases, the average number of particles passing through each hit decreases and the impact of Landau fluctuations increases.  Any technique used for minimising the impact of Landau fluctuations will be sensitive to the transverse segmentation of the calorimeters in use.  

%========================================================================================

\subsection{HCal Hit Energy Truncation}
\label{sec:hcalcelltruncation}
The first technique to be examined is a simple truncation of the hadronic energy, $E$, recorded in any given HCal hit
%
\begin{equation}
E \rightarrow E' =
\begin{cases}
E & \text{if } E < \kappa \text{ ,} \\
\kappa & \text{otherwise} \text{ ,}
\end{cases}
\end{equation}
%
\noindent where $\kappa$ is the value of the truncation.  This improves the energy estimators for hadronic clusters by limiting the impact of Landau fluctuations.  In terms of $\omega$ introduced in equation \ref{equ:compensation} the truncation corresponds to
%
\begin{equation}
\omega(\rho) =
\begin{cases}
1 & \text{if } \rho \times V < \kappa \text{ ,} \\
\frac{\kappa}{\rho \times V} & \text{otherwise} \text{ .}
\end{cases}
\end{equation}
%
\noindent This weight as a function of hit energy density is shown in figure \ref{fig:hcalcellweight}.  

\begin{figure}[h!]
\includegraphics[width=0.5\textwidth]{EnergyEstimators/Plots/SoftComp/Weights/CellTruncWeights.pdf}
\caption[The weights, $\omega$, used in the HCal hit energy truncation as a function of the energy density of the HCal hit, $\rho$.  The truncation shown here corresponds to a 1~GeV truncation in the nominal ILD HCal.]{The weights, $\omega$, used in the HCal hit energy truncation as a function of the energy density of the HCal hit, $\rho$.  The truncation shown here corresponds to a 1~GeV truncation in the nominal ILD HCal.}
\label{fig:hcalcellweight}
\end{figure}

%========================================================================================

\subsubsection{Legacy Energy Corrections}
\label{sec:legacycorrections}
Alongside the HCal hit energy truncation, PandoraPFA also applied two other energy corrections designed at limiting the impact of Landau fluctuations.  They are:

\begin{itemize}
\item \textbf{Clean Clusters}.  This algorithm checks to see whether the energy measured within a calorimeter hit is anomalously high.  Anomalously high energy hits are defined as hits where the energy contained within the hit is greater than 10\% of the energy of the cluster that the hit has been associated to.  If a hit is deemed to have an anomalously high energy and if this energy is above a threshold (0.5~GeV) the hit energy used by PandoraPFA is modified.  The updated hit energy is taken as the average hit energy in the calorimeter layers immediately before and after the layer containing the high energy hit.    
\item \textbf{Scale Hot Hadrons}.  This algorithm calculates the average number of MIP equivalent particles passing through each calorimeter hit in a cluster.  If this number is larger than a given value, default 15 MIPs per hit, the cluster energy is rescaled to give a lower average number of MIPs per hit, default is 5 MIPs per hit.  
\end{itemize}

These algorithms, with the HCal hit truncation, form the "legacy" energy corrections that are used by PandoraPFA when performing the event reconstruction.    

%========================================================================================

\subsubsection{Impact on Single Particle Energy Resolution}
Figure \ref{fig:ercelltrunckaons} shows the energy resolution for neutral hadrons as a function of the HCal hit energy truncation.  The optimal truncation for the ILD detector model simulation was 1~GeV and, using this truncation, a neutral hadron energy resolution of $\sim$8.8\% was obtained.  This energy resolution is approximately $\sim$1.6\% lower than that obtained without the use of a truncation.  Smaller energy truncations begin to truncate the energy of calorimeter hits produced in typical hadronic shower development, while larger truncations allow for a larger impact from Landau fluctuations.  Both of these effects result in worsening neutral hadron energy resolutions.  For completeness the $\gamma$ energy resolutions as a function of HCal hit energy truncation are shown in figure \ref{fig:ercelltruncphotons}.  As expected the $\gamma$ energy resolution is unaffected by the HCal hit energy truncation as the $\gamma$s are largely contained within the ECal.

\begin{figure}[h!]
\subfloat[]{\label{fig:ercelltrunckaons}\includegraphics[width=0.5\textwidth]{EnergyEstimators/Plots/CellTruncation/ER_vs_Kaon0LCellTrunc_50GeVKaon0L.pdf}}
\subfloat[]{\label{fig:ercelltruncphotons}\includegraphics[width=0.5\textwidth]{EnergyEstimators/Plots/CellTruncation/ER_vs_PhotonCellTrunc_100GeVPhoton.pdf}}
\caption[The energy resolution as a function of HCal cell truncation for \protect\subref{fig:ercelltrunckaons} 50~GeV $K^{0}_{L}$ events and \protect\subref{fig:ercelltruncphotons} 100~GeV $\gamma$ events using the nominal ILD detector model.]{The energy resolution as a function of HCal cell truncation for \protect\subref{fig:ercelltrunckaons} 50~GeV $K^{0}_{L}$ events and \protect\subref{fig:ercelltruncphotons} 100~GeV $\gamma$ events using the nominal ILD detector model.}
\label{fig:ercelltrunc}
\end{figure}

%========================================================================================

\subsubsection{Impact on Jet Energy Resolution}
Figure \ref{fig:jercelltrunc} shows the jet energy resolution as a function of jet energy for selected values of the HCal hit energy truncation.  The trends in this plot are complex as the optimal HCal hit energy truncation varies with the jet energy.  For 45.5~GeV jets, the best jet energy resolution, $\sim$3.55\%, is obtained using a 0.5~GeV truncation, while for 180~GeV jets, the best jet energy resolution, $\sim$2.85\%, is obtained using a 1~GeV truncation.  This is expected as at low jet energies the average number of particles passing through each active calorimeter hit will be small, meaning the impact of Landau fluctuations is large and that to limit them a small truncation is needed.  As the jet energy increases more particles on average pass through each calorimeter hit and the impact of Landau fluctuations decreases.  

\begin{figure}[h!]
\includegraphics[width=0.5\textwidth]{EnergyEstimators/Plots/CellTruncation/JER_vs_JetEnergy_HCalCellTruncation.pdf}
\caption[The jet energy resolution as a function of jet energy for various HCal hit energy truncations.  The results shown use the nominal ILD detector model, which contains $30\times30 \text{ mm}^{2}$ square scintillator tiles in the HCal.]{The jet energy resolution as a function of jet energy for various HCal hit energy truncations.  The results shown use the nominal ILD detector model, which contains $30\times30 \text{ mm}^{2}$ square scintillator tiles in the HCal.}
\label{fig:jercelltrunc}
\end{figure}

It is clear that a 1~GeV HCal hit energy truncation is beneficial for the performance of the nominal ILD detector model as the jet energy resolution is reduced by roughly $\sim$0.15\% across the jet energy range from 45.5~GeV to 250~GeV.  As the HCal hit truncation technique offers significant performance gains, it is used for the calorimeter optimisation studies presented in chapter \ref{chap:detopt}.  Included in those studies is an optimisation of the HCal cell size.  Increasing the HCal cell size will increase the average number of particles passing through each calorimeter hit, which in turn reduces the impact of Landau fluctuations and vice verse.  For all detector models considered where the HCal cell size was varied, the HCal hit energy truncation was reoptimsied to account for the changing impact of Landau fluctuations.  For detector models with a HCal cell size of 10, 20, 30, 40, 50 and 100~mm the reoptimised truncations were 0.5, 0.75, 1, 1.5, 2 and 5~GeV respectively.  Furthermore, the average particle density in a HCal hit will also be sensitive to the properties of the absorber material used in the calorimeters, therefore, the HCal hit energy truncation was also reoptimised in the HCal absorber material study.  The optimal truncation for tungsten HCal options was 5~GeV, while for all other detector models considered it was 1~GeV.

Understanding the affect of the HCal hit energy truncation is crucial when performing optimisation studies.  This can be seen in figure \ref{fig:jerhcalcellopt}, which shows the results of the HCal cell size optimisation study when using a 1~GeV truncation and when optimising the truncation for each detector model.  By applying a uniform HCal hit energy truncation the importance of the HCal cell size to particle flow calorimetry is vastly overinflated.  For example, if the HCal cell size is increased from 10~mm to 100~mm the jet energy resolution for 250~GeV jets goes from $\sim$2.8\% to $\sim$4.5\% for the flat 1~GeV truncation, but only $\sim$3.5\% when using an optimised truncation.  As the jet energy and HCal cell size increase, the flat 1~GeV truncation throws away a larger fraction of typical hadronic shower energy measurements, which causes the jet energy resolution to degrade rapidly.  

\begin{figure}[h!]
\subfloat[]{\label{fig:jerhcalcelloptgoodtrunc}\includegraphics[width=0.5\textwidth]{OptimisationStudies/Plots/JetEnergyResolutions/JER_vs_HCalCellSize.pdf}}
\subfloat[]{\label{fig:jerhcalcelloptbadtrunc}\includegraphics[width=0.5\textwidth]{EnergyEstimators/Plots/CellTruncation/JER_vs_HCalCellSizeBadTruncation.pdf}}
\caption[The jet energy resolution as a function of HCal cell size in the ILD detector model using a HCal hit energy truncation that is \protect\subref{fig:jerhcalcelloptgoodtrunc} optimised and \protect\subref{fig:jerhcalcelloptbadtrunc} fixed at 1~GeV.]{The jet energy resolution as a function of HCal cell size in the ILD detector model using a HCal hit energy truncation that is \protect\subref{fig:jerhcalcelloptgoodtrunc} optimised and \protect\subref{fig:jerhcalcelloptbadtrunc} fixed at 1~GeV.}
\label{fig:jerhcalcellopt}
\end{figure}

%========================================================================================

\subsection{Software Compensation}
\label{sec:softcomp}
Particle showers that are produced when a hadron interacts with a calorimeter contain two components \cite{Wigmans:2000vf}; an electromagnetic shower core, which originates from the production and decay of $\pi^{0}$s and $\eta$s, and a hadronic shower component originating from other interacting and decaying particles.  By identifying each of these components in the reconstruction, it is possible to modify their energies to give a compensating calorimeter response.  This technique known as software compensation.  

Software compensation achieves a compensating calorimeter response by applying weights, as introduced in equation \ref{equ:compensation}, that modify the energy of calorimeter hits in the HCal.  These weights increase the energy found in the hadronic hits to compensate for the undetectable energy component found in hadronic showers.  Additionally, these weights is to reduce the energy of spuriously high energy hits to minimise the impact of Landau fluctuations.  The weights vary as a function of the calorimeter hit energy density, $\rho^{i}$, and the uncompensated energy of the particle shower, $E_{Raw}$, where 
%
\begin{equation}
E_{Raw} & = \sum_{ECal \text{ } hits \text{, }i} E^{i}_{ECal} +\sum_{HCal \text{ } hits \text{, }i} E^{i}_{HCal} \text{ .}
\label{equ:eraw}
\end{equation}
%
\noindent  The electromagnetic and hadronic components of a hadronic particle shower are treated differently in this approach by applying wights that are sensitive to the energy density of the calorimeter hits.  High energy density hits are likely to be part of the electromagnetic core, while low energy density hits are likely to be part of satellite hadronic hits around the electromagnetic shower core \cite{Adloff:2012gv}.  By tailoring the weights as a function of the energy density, a compensating calorimeter response can be obtained.  Figure \ref{fig:softcompeventdisplay} shows the electromagnetic and hadronic shower components, determined by the energy density of the calorimeter hits, for a hadronic shower in a 500~GeV Z$\rightarrow$uds di-jet event.  

\begin{figure}[h!]
\subfloat[]{\label{fig:softcompfulleventdisplay}\includegraphics[width=0.5\textwidth]{EnergyEstimators/Plots/SoftComp/VisualDisplay/SoftComp1.png}}
\subfloat[]{\label{fig:softcompclustereventdisplay}\includegraphics[width=0.3\textwidth]{EnergyEstimators/Plots/SoftComp/VisualDisplay/SoftComp3.png}}
\caption[An event display for a 500~GeV Z$\rightarrow$uds di-jet event reconstructed using the nominal ILD detector.  \protect\subref{fig:softcompfulleventdisplay} The full event environment.  \protect\subref{fig:softcompclustereventdisplay} A single hadronic cluster from the same event where shading indicates the energy density in the HCal.  High energy density cells are coloured red, while lower energy density cells are coloured blue.  All ECal hits are shaded black.  The high energy density electromagnetic core of the selected hadronic cluster is clearly visible.]{An event display for a 500~GeV Z$\rightarrow$uds di-jet event reconstructed using the nominal ILD detector.  \protect\subref{fig:softcompfulleventdisplay} The full event environment.  \protect\subref{fig:softcompclustereventdisplay} A single hadronic cluster from the same event where shading indicates the energy density in the HCal.  High energy density cells are coloured red, while lower energy density cells are coloured blue.  All ECal hits are shaded black.  The high energy density electromagnetic core of the selected hadronic cluster is clearly visible.}
\label{fig:softcompeventdisplay}
\end{figure}

The software compensation weights also depend on $E_{Raw}$ to account for the sensitivity of the hit energy density distribution on the total particle shower energy.  For hadronic showers, the fraction of the total energy carried in the electromagnetic core increases as the total shower energy increases \cite{Wigmans:2000vf}, therefore a dependancy of the weights on $E_{Raw}$ is needed to obtain a compensating calorimeter response across a wide range of energies.  

The precise form of the weights used for this technique are \cite{Adloff:2012gv}
%
\begin{equation}
\omega(E_{Raw}, \rho) = p_{1}(E_{Raw}) \times \text{exp}(p_{2}(E_{Raw}) \times \rho) + p_{3}(E_{Raw}) \\
p_{1}(E_{Raw}) = p_{11} + p_{12} \times E_{Raw} + p_{13} \times E_{Raw}^{2} \\
p_{2}(E_{Raw}) = p_{21} + p_{22} \times E_{Raw} + p_{23} \times E_{Raw}^{2} \\
p_{3}(E_{Raw}) = \frac{p_{31}}{p_{32} + \text{exp}(p_{33} \times E_{Raw})}\text{ ,}
\label{equ:softcompweight}
\end{equation}
\noindent where $p_{\alpha\beta}$ are constants and
\begin{equation}
E_{Raw} & = \sum_{ECal \text{ } hits \text{, }i} E^{i}_{ECal} +\sum_{HCal \text{ } hits \text{, }i} E^{i}_{HCal} \text{ .}
\end{equation}
%
\noindent The parameters $p_{\alpha\beta}$ were determined by minimising $\chi^{2}(p_{\alpha\beta})$ where
%
\begin{equation}
\chi^{2}(p_{\alpha\beta}) = \sum_{Events} \bigg( \frac{(E_{SC,Cluster}(p_{\alpha\beta}) - E_{MC})}{0.5 \times \sqrt{E_{MC}}} \bigg)^{2}
\end{equation}
%
where the sum runs over single $K^{0}_{L}$ events that ranged in energy from 10 to 100~GeV in steps of 10~GeV.  At each energy the same number of events was used to avoid biasing to particular energies.  In each event, $E_{SC,Cluster}$ is the software compensated energy estimator for the reconstructed event and $E_{MC}$ is the MC energy of the $K^{0}_{L}$.  Normalising the deviation of $E_{SC,Cluster}$ from $E_{MC}$ by the stochastic term in the HCal energy resolution, $\sim 50\% \times \sqrt{E}$, made sure events of different MC energy contributed the same weight to $\chi^{2}$.  

Using the fitted parameters obtained for the nominal ILD detector, $p_{1}$, $p_{2}$ and $p_{3}$ as a function of $E_{Raw}$ is shown in figure \ref{fig:softcompparams} and $\omega(E_{Raw}, \rho)$ as a function of $\rho$ for selected values of $E_{Raw}$ is shown in figure \ref{fig:softcompweights}.  Figure \ref{fig:softcompweights} shows that the high energy density hits are being reduced in energy to compensate for the effects of Landau fluctuations, while the low energy density hits are being increased in weight to compensate for the undetectable energy component found in hadronic showers.  Furthermore, the weights vary as a function of the raw hadronic shower energy to account for the changing energy density topology of hadronic showers with increasing shower energy.

\begin{figure}[h!]
\subfloat[]{\label{fig:softcompparam1}\includegraphics[width=0.33\textwidth]{EnergyEstimators/Plots/SoftComp/Weights/SoftwareCompensationParam1.pdf}}
\subfloat[]{\label{fig:softcompparam2}\includegraphics[width=0.33\textwidth]{EnergyEstimators/Plots/SoftComp/Weights/SoftwareCompensationParam2.pdf}}
\subfloat[]{\label{fig:softcompparam3}\includegraphics[width=0.33\textwidth]{EnergyEstimators/Plots/SoftComp/Weights/SoftwareCompensationParam3.pdf}}
\caption[Parameters used in software compensation weight determination as a function of $E_{Raw}$.]{Parameters used in software compensation weight determination as a function of $E_{Raw}$.}
\label{fig:softcompparams}
\end{figure}

\begin{figure}[h!]
\includegraphics[width=0.5\textwidth]{EnergyEstimators/Plots/SoftComp/Weights/SoftwareCompensationWeights.pdf}
\caption[The software compensation weight applied to a calorimeter hit as a function of calorimeter hit energy density for various cluster energies.]{The software compensation weight applied to a calorimeter hit as a function of calorimeter hit energy density for various cluster energies.}
\label{fig:softcompweights}
\end{figure}

This technique is applied in the PandoraPFA framework in the form of an energy correction function, which means whenever the energy of a cluster of hits is considered by PandoraPFA the software compensated energy is used.  Applying software compensation in this way benefits the detector energy resolution in two ways; firstly, the intrinsic energy resolution of the detector improves and secondly, the confusion contribution to the energy resolution is reduced.

As software compensation only modifies the energy of HCal hits there is freedom to apply further energy corrections to the ECal hits.  Applying the "Clean Clusters" logic, described in section \ref{sec:legacycorrections}, to the ECal hits alongside software compensation was found to be beneficial to the jet energy resolution.  Therefore, the application of software compensation within PandoraPFA implicitly involves the application of the "Clean Clusters" logic to the ECal hits.  

Software compensation was tuned using a maximum $K^{0}_{L}$ energy of 100~GeV, therefore, it is only applied to clusters where $E_{Raw} < 100$~GeV as sensible behaviour outside this range cannot be ensured.  While it would be possible to modify the energy range of the training sample to go to higher energies, hadronic clusters with energy greater than 100~GeV will be rare at the ILC like energies considered here.

%========================================================================================

\subsubsection{Impact on Single Particle Energy Resolution}
\label{sec:softcomper}
Figure \ref{fig:ersoftcomp} shows the energy resolution as a function of MC energy for single $K^{0}_{L}$ events obtained using various energy correction configurations in PandoraPFA.  When comparing the energy resolution given by software compensation to that obtained using no energy corrections, it can be seen that software compensation offers an improvement in the energy resolution of $\approx 15 \%$ across the energy range considered.  The uniformity of this improvement is encouraging, indicating that software compensation is achieving a compensating calorimeter response across this wide range of energies.  

Comparing the performance of software compensation to the legacy corrections, described in section \ref{sec:legacycorrections}, it can be seen that software compensation gives a better energy resolution across almost the entire range of energies considered.  The only exception to this is around $E_{K^{0}_{L}} \approx 50$~GeV where the performance of software compensation and the legacy corrections are comparable.  By removing the hit truncation from the legacy options it is clear that the changes in energy resolution when using the legacy options are being driven by the hit truncation.  This makes the trend in energy resolution observed using the legacy corrections clear as, at low $K^{0}_{L}$ energies, very few hits are affected by the truncation so the performance is comparable to not using any energy corrections.  At high $K^{0}_{L}$ energies, the truncation is too aggressive and removes energy from hits that are not spuriously high leading to a worsening energy resolution.  Between these two extremes, $E_{K^{0}_{L}} \approx 50$~GeV, the truncation works ideally and the improvement in energy resolution when using the legacy corrections is the largest.  

\begin{figure}[h!]
\includegraphics[width=0.75\textwidth]{EnergyEstimators/Plots/SoftComp/EnergyResolution/ER_vs_Kaon0LSoftComp_Kaon0L.pdf}
\caption[The energy resolution as a function of the MC energy for single $K^{0}_{L}$ events using various energy correction settings.  The nominal ILD detector model was used in these simulations.]{The energy resolution as a function of the MC energy for single $K^{0}_{L}$ events using various energy correction settings.  The nominal ILD detector model was used in these simulations.}
\label{fig:ersoftcomp}
\end{figure}

%========================================================================================

\subsubsection{Impact on Jet Energy Resolution}
The improvements in the intrinsic energy resolution of the detector observed when using software compensation will propagate into the reconstruction of jets.  These effects are illustrated by examining the jet energy resolution as a function of jet energy, which is shown in figure \ref{fig:jersoftcomp}.  Again it is clear that software compensation is extremely beneficial to the detector performance as it gives a significant reduction in the jet energy resolution in comparison to using the legacy energy corrections.  

\begin{figure}[h!]
\includegraphics[width=0.5\textwidth]{EnergyEstimators/Plots/SoftComp/JetEnergyResolution/JER_vs_JetEnergy_Default.pdf}
\caption[The jet energy resolution as a function of the jet energy for a variety of different energy correction options.  The nominal ILD detector model was used in these simulations.]{The jet energy resolution as a function of the jet energy for a variety of different energy correction options.  The nominal ILD detector model was used in these simulations.}
\label{fig:jersoftcomp}
\end{figure}

Further light can be shed on these trends by examining the contributions to the jet energy resolutions from the intrinsic energy resolution and the pattern recognition confusion, which are shown in figure \ref{fig:jerbreakdownsoftcomp}.  The intrinsic energy resolution contribution shows that software compensation is significantly better than all other energy corrections options, which is to be expected from the energy resolution studies presented in section \ref{sec:softcomper}.  Unlike the single particle study there is no jet energy for which the hit truncation matches the performance obtained using software compensation.  This is due to the fact that the energy resolution when using the hit truncation is only comparable to the energy resolution using software compensation for a narrow range of hadronic cluster energies.  As the jet contains a broad spectrum of hadronic cluster energies the performance obtained when using the hit truncation will always be worse than when using software compensation.  When comparing the jet energy resolution for the legacy corrections is again apparent that the term driving the jet energy resolution is the hit truncation.

\begin{figure}[h!]
\subfloat[]{\label{fig:jerbreakdownsoftcomp1}\includegraphics[width=0.5\textwidth]{EnergyEstimators/Plots/SoftComp/JetEnergyResolution/JER_vs_JetEnergy_PerfectPFA.pdf}}
\subfloat[]{\label{fig:jerbreakdownsoftcomp2}\includegraphics[width=0.5\textwidth]{EnergyEstimators/Plots/SoftComp/JetEnergyResolution/JER_vs_JetEnergy_TotalConfusion.pdf}}
\caption[The contributions to the jet energy resolution as a function of the jet energy for a variety of different energy correction options.  \protect\subref{fig:jerbreakdownsoftcomp1} is the intrinsic energy resolution of the detector and \protect\subref{fig:jerbreakdownsoftcomp2} is the total confusion term.  The quadrature sum of both yields the standard reconstruction performance.  These results were produced for the nominal ILD detector model.]{The contributions to the jet energy resolution as a function of the jet energy for a variety of different energy correction options.  \protect\subref{fig:jerbreakdownsoftcomp1} is the intrinsic energy resolution of the detector and \protect\subref{fig:jerbreakdownsoftcomp2} is the total confusion term.  The quadrature sum of both yields the standard reconstruction performance.  These results were produced for the nominal ILD detector model.}
\label{fig:jerbreakdownsoftcomp}
\end{figure}

The confusion contributions to the jet energy resolution when using software compensation and the legacy corrections are almost identical.  This indicates that the improvement seen in the jet energy resolution when comparing software compensation and the legacy corrections, shown in figure \ref{fig:jersoftcomp}, is being driven by the intrinsic energy resolution.  The hit truncation and software compensation techniques both improve the energy resolution of the hadronic clusters, however, software compensation is far more effective.  

At low jet energies the Clean Clusters and Scale Hot Hadrons energy corrections are beneficial for reducing the confusion contribution, while the hit truncation is largely redundant.  For high jet energies jets this trend is reversed.  As the Clean Clusters and Scale Hot Hadrons energy corrections do not alter the intrinsic energy resolution of the detector, it is clear that they are compensating for failures in the pattern recognition, which occur primarily at low jet energies.  By extracting the Clean Clusters logic, which is the driving term reducing the confusion contribution to the jet energy resolution at low jet energies, and embedding it within the software compensation energy correction, it is possible to obtain exceptional jet energy resolutions that will extend the physics reach of the linear collider detector.  

%========================================================================================
%========================================================================================

\section{Timing Cuts}
The linear collider will operate using a trigger-less readout approach whereby the recorded data for each sub-detector is readout between collisions of $\text{e}^{+}$ and $\text{e}^{-}$ bunches.  The train structure for ILC and CLIC, at their maximum operating energy, is shown in table \ref{table:trainstructure}.  Event selection will proceed through the application of a software trigger.  This involves the identification of any hard interactions, prior to full event reconstruction, and only putting data into the event reconstruction if it is measured within a chosen time window about these interactions.  The recorded time of a calorimeter hit, which is cut on to make the time window for the software trigger, is corrected for straight time-of-flight to the IP.  This ensures that the amount of time particle showers have to develop in the calorimeters is independent of their position in the detector.  As the width of this time window changes, the amount of time particle showers have to develop changes, which will affect the performance of the detector.  

\begin{table}[h!]
\centering
\begin{tabular}{l r r}
\hline
& ILC 500~GeV & CLIC 3 TeV \\
\hline
Electrons per bunch [$10^{10}$] & 2.0 & 0.37 \\
Bunches per train & 2820 & 312 \\
Train repetition rate [Hz] & 5 & 50 \\
Bunch separation [ns] & 308 & 0.5 \\
\end{tabular}
\caption[The train structure for 500~GeV ILC and 3 TeV CLIC \cite{Behnke:2013lya,Linssen:2012hp}.]{The train structure for 500~GeV ILC and 3 TeV CLIC \cite{Behnke:2013lya,Linssen:2012hp}.}
\label{table:trainstructure}
\end{table}

For all choices of time window considered in this study the calibration procedure described in section \ref{sec:overviewcalibration} was applied.  This ensure that the mean of the reconstructed energy distributions will be invariant to changes in the calorimeter timing window as the calibration procedure compensates for any energy losses incurred by truncating the particle shower development time.  

%========================================================================================

\subsubsection{Results: Energy Resolution}
The energy resolution for100~GeV $\gamma$ and 50~GeV $K^{0}_{L}$ events as a function of the timing window applied to the calorimeter hits is shown, for the nominal ILD detector, in figure \ref{fig:ertimingcuts}.  The timing cut makes little difference to the energy resolution of the $\gamma$ events, however, there is a significant decrease in the energy resolution for the neutral hadrons.  This is to be expected as electromagnetic showers develop far more rapidly than their hadronic counterparts \cite{Wigmans:2000vf}, which is shown in figure \ref{fig:calohittiming}.  Hadronic showers develop slowly as they often involve intermediate states that must decay to continue the propagation of the shower and as these states have non-zero lifetimes they slow the propagation of the shower.  If a narrow calorimeter timing window is used, energy measurements from the hadronic shower will be lost and the energy resolution will degrade, which is what is observed.  

\begin{figure}[h!]
\subfloat[]{\label{fig:ertimingcutsphotons}\includegraphics[width=0.5\textwidth]{EnergyEstimators/Plots/TimingCuts/ER_vs_PhotonTiming_100GeVPhoton.pdf}}
\subfloat[]{\label{fig:ertimingcutskaons}\includegraphics[width=0.5\textwidth]{EnergyEstimators/Plots/TimingCuts/ER_vs_Kaon0LTiming_50GeVKaon0L.pdf}}
\caption[The energy resolution as a function of calorimeter timing window for \protect\subref{fig:ertimingcutsphotons} 100~GeV $\gamma$ events and \protect\subref{fig:ertimingcutskaons} 50~GeV $K^{0}_{L}$ events using the nominal ILD detector model.]{The energy resolution as a function of calorimeter timing window for \protect\subref{fig:ertimingcutsphotons} 100~GeV $\gamma$ events and \protect\subref{fig:ertimingcutskaons} 50~GeV $K^{0}_{L}$ events using the nominal ILD detector model.}
\label{fig:ertimingcuts}
\end{figure}

\begin{figure}[h!]
\centering
\includegraphics[width=0.5\textwidth]{OptimisationStudies/Plots/Description/CalorimeterHitTimes_91GeV_Z_uds_Steel.pdf}
\caption[The distribution of the time of the calorimeter hits, corrected for time of flight to the impact point, for 91~GeV Z$\rightarrow$uds di-jet events.]{The distribution of the time of the calorimeter hits, corrected for time of flight to the impact point, for 91~GeV Z$\rightarrow$uds di-jet events.}
\label{fig:calohittiming}
\end{figure} 

%========================================================================================

\subsubsection{Results: Jet Energy Resolution}
The jet energy resolution as a function of the jet energy for selected calorimeter time windows is shown in figure \ref{fig:jertimingcuts}.  As expected, the jet energy resolution will also be affected by the reduced neutral hadron energy resolution when the calorimeter timing window is reduced.  The sole exception to this is the 250~GeV jets for the 100~ns time window whereby the jet energy resolution is slightly better than when using the 300~ns and semi-infinite time windows.  As the magnitude of the changes to the jet energy resolution when varying the time window size are small in comparison to the absolute resolutions, this exception will most likely be due to a fluctuation in either the event sample used or in the application of the calibration procedure.  

\begin{figure}[h!]
\includegraphics[width=0.5\textwidth]{EnergyEstimators/Plots/TimingCuts/JER_vs_JetEnergy_TimingCutStudies.pdf}
\caption[The jet energy resolution as a function of jet energy for various calorimeter timing cuts.  The results shown use the nominal ILD detector model.]{The jet energy resolution as a function of jet energy for various calorimeter timing cuts.  The nominal ILD detector model was used for this study.}
\label{fig:jertimingcuts}
\end{figure}

The time window applied to the calorimeter hits affects both the neutral hadron and jet energy resolutions with a larger timing window leading to better resolutions.  It can be seen that applying an aggressive choice of time window, such as 10~ns, the jet energy resolution is degraded as many of the hadronic showers being sampled do not have time to fully develop.  However, even using a 10~ns timing cut the jet energy resolutions are still sufficiently low to give excellent detector performance.  Both the single particle and jet energy resolutions indicate that the majority of hadronic showers will have fully developed within 100~ns and that there are little gains to be made by extending the size of this window.  

For results presented in this chapter and the optimisation studies found in chapter \ref{chap:detopt} a 100~ns timing window was applied across all models considered.  As the choice of timing window has yet to be finalised for the linear collider this value was chosen as it represents something that could be achieved using the readout technology options presently available \cite{Adloff:2014rya}.  Furthermore, it adds additional realism to the detector simulation in comparison to omitting the effect of the calorimeter time window.  The categorisation of changes to the detector performance when varying the calorimeter timing window presented here can be used to discern the impact of changing the timing window used for the optimisation studies at a later date if so desired.  

%========================================================================================
%========================================================================================
